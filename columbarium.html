<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#111111" />
  <title>Sketcher â€“ Columbarium</title>
  <link rel="stylesheet" href="./css/styles.css" />
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:#111; color:#eee; }
  .btn { background:#1f6feb; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; font-size:13px; }
  .btn.secondary { background:#333; color:#ddd; }
  .btn:disabled { opacity:0.6; cursor:not-allowed; }
  /* Pannable grid canvas */
  #gridStage { position: fixed; top:0; left:0; width:100vw; height:100vh; z-index: 0; display: block; cursor: grab; }
  #gridStage.grabbing { cursor: grabbing; }
  /* UI overlay for controls can stack above */
  .row { display:flex; gap:6px; }
    a.link { color:#9ecbff; text-decoration:none; }
    a.link:hover { text-decoration:underline; }
    /* Modal viewer */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:99; }
    .modal { width:min(92vw, 960px); height:min(82vh, 640px); background:#111; border:1px solid #333; border-radius:8px; overflow:hidden; display:flex; flex-direction:column; }
    .modal header { border-bottom:1px solid #333; }
    .modal main { flex:1; position:relative; }
    .canvas-wrap { position:absolute; inset:0; }
    .modal footer { border-top:1px solid #333; padding:8px; display:flex; justify-content:flex-end; gap:8px; }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "./js/vendor/three.module.js"
      }
    }
  </script>
</head>
<body class="columbarium">
  <div id="pageFade" aria-hidden="true"></div>
  <!-- Toolbox-like controls for Columbarium (consistent with editor) -->
  <div id="cToolbox">
    <div id="cTopIcons">
      <button id="cToggleImport" class="icon-btn toggle-btn" title="Import" aria-label="Import" aria-pressed="false">
      <span class="sr-only">Import</span>
      <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="#222" stroke-width="2"/><path d="M12 8v6" stroke="#222" stroke-width="2"/><path d="M9 14l3 3 3-3" fill="none" stroke="#222" stroke-width="2"/></svg>
      </button>
      <div id="cImportGroup" class="collapse" aria-hidden="true" style="width:100%;">
        <button id="importBtn" class="icon-btn" title="Import Scene JSON" aria-label="Import Scene JSON">
          <span class="sr-only">Import Scene JSON</span>
          <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="#222" stroke-width="2"/><path d="M12 8v6" stroke="#222" stroke-width="2"/><path d="M9 14l3 3 3-3" fill="none" stroke="#222" stroke-width="2"/></svg>
        </button>
        <input id="importInput" type="file" accept="application/json,.json,.gltf,.glb,.obj" style="display:none" />
      </div>
      <button id="cCenterView" class="icon-btn" title="Center View" aria-label="Center View">
      <span class="sr-only">Center View</span>
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="7" fill="none" stroke="#222" stroke-width="2"/><circle cx="12" cy="12" r="2" fill="#222"/></svg>
    </button>
      <!-- Zones tool -->
      <button id="cToggleZones" class="icon-btn toggle-btn" title="Zones" aria-label="Zones" aria-pressed="false">
      <span class="sr-only">Zones</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <!-- Transparent container box -->
        <rect x="3.5" y="3.5" width="17" height="17" rx="3" fill="none" stroke="#222" stroke-width="2"/>
        <!-- Solid color plus in top-left corner -->
        <g id="zonesParentPlus" fill="#ffbf00">
          <rect x="5" y="5" width="6" height="2" rx="1"/>
          <rect x="7" y="3" width="2" height="6" rx="1"/>
        </g>
      </svg>
    </button>
  </div>
    <div id="cZonesGroup" class="collapse" aria-hidden="true">
  <div class="row center">
        <button id="zoneCreate" class="icon-btn toggle-btn" title="Create Zone" aria-label="Create Zone" aria-pressed="false">
          <span class="sr-only">Create Zone</span>
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 5v14M5 12h14" stroke="#222" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
  <div class="row center" style="padding: 4px 0;">
        <input id="zoneColor" type="color" value="#ffbf00" title="Zone Color" aria-label="Zone Color" style="width:36px;height:36px;padding:0;border:none;background:none;box-shadow:0 1px 4px rgba(0,0,0,0.08);"/>
      </div>
  <div class="row end">
        <button id="zoneClear" class="icon-btn" title="Clear All Zones" aria-label="Clear All Zones">
          <span class="sr-only">Clear All Zones</span>
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="12" r="8" fill="none" stroke="#222" stroke-width="2" />
            <line x1="7" y1="17" x2="17" y2="7" stroke="#222" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </div>
    </div>
  </div>
  <canvas id="gridStage" aria-label="Columbarium Grid"></canvas>
  <div class="page-vignette" aria-hidden="true"></div>

  <div id="viewerBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h1 id="viewerTitle" style="font-size:16px; font-weight:600; margin:0;">Preview</h1>
      </header>
      <main>
        <div class="canvas-wrap"><canvas id="viewerCanvas"></canvas></div>
      </main>
      <footer>
        <button id="viewerClose" class="btn secondary">Close</button>
      </footer>
    </div>
  </div>

  <!-- Floating button back to editor - top-left for consistency -->
  <a id="toEditorFloating" class="floating-nav nav-top-right" href="./index.html" title="Back to Editor" aria-label="Back to Editor">
    <!-- Clean perspective grid icon -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <g fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round">
        <!-- Outer trapezoid (grid boundary) -->
        <path d="M9 8 L15 8 L20 18 L4 18 Z" stroke-width="1.4" opacity=".95"/>
        <!-- Horizontal grid lines (foreshortened) -->
        <path d="M8 10 H16" stroke-width="1.2" opacity=".9"/>
        <path d="M7 12 H17" stroke-width="1.1" opacity=".85"/>
        <path d="M6 14 H18" stroke-width="1.05" opacity=".8"/>
        <path d="M5 16 H19" stroke-width="1" opacity=".75"/>
        <!-- Vertical convergence lines to top center -->
        <path d="M4 18 L9 8" stroke-width="1" opacity=".8"/>
        <path d="M8 18 L11 8" stroke-width="1" opacity=".8"/>
        <path d="M12 18 L12 8" stroke-width="1" opacity=".8"/>
        <path d="M16 18 L13 8" stroke-width="1" opacity=".8"/>
        <path d="M20 18 L15 8" stroke-width="1" opacity=".8"/>
      </g>
    </svg>
  </a>
  <!-- Floating AnArch trigger button -->
  <button id="toAnArch" class="floating-nav nav-top-right-2" title="AnArch Glitch" aria-label="AnArch Glitch" type="button">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <!-- Stylized A with shard lines -->
      <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 4 L5 20 M12 4 L19 20 M7.5 15 H16.5"/>
        <path d="M3 8 L7 8" opacity=".5"/>
        <path d="M17 10 L21 10" opacity=".5"/>
      </g>
    </svg>
  </button>
  <script type="module">
    // Page fade-in/out
    document.addEventListener('DOMContentLoaded', () => {
      requestAnimationFrame(()=>document.body.classList.add('page-ready'));
  const hooks = [document.getElementById('toEditorFloating')].filter(Boolean);
      hooks.forEach(el => el.addEventListener('click', (e) => {
        e.preventDefault();
        const href = el.getAttribute('href');
  document.body.classList.add('page-leave');
  setTimeout(()=>{ window.location.href = href; }, 170);
      }));
    });
  // Load modules: preview/import wiring and interactive grid
  import('./js/app/columbarium.js');
  import('./js/app/columbarium-grid.js');
  // Toolbox behavior
  const cToggleImport = document.getElementById('cToggleImport');
  const cImportGroup = document.getElementById('cImportGroup');
  if (cToggleImport && cImportGroup) {
    cToggleImport.addEventListener('click', () => {
      const isOpen = cImportGroup.classList.contains('open');
      cImportGroup.classList.toggle('open', !isOpen);
      cImportGroup.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
      cToggleImport.setAttribute('aria-pressed', isOpen ? 'false' : 'true');
    });
  }
  const cCenterView = document.getElementById('cCenterView');
  if (cCenterView) cCenterView.addEventListener('click', ()=> window.dispatchEvent(new CustomEvent('columbarium:center')));
  // AnArch trigger
  (async () => { try {
    const mod = await import('./js/app/anarch.js');
    const toAnArch = document.getElementById('toAnArch');
    if (mod && mod.triggerAnArchSequence && toAnArch) toAnArch.addEventListener('click', () => { try { mod.triggerAnArchSequence(); } catch {} });
  } catch {} })();
  // Zones toolbox wiring
  const cToggleZones = document.getElementById('cToggleZones');
  const cZonesGroup = document.getElementById('cZonesGroup');
  const zoneColor = document.getElementById('zoneColor');
  const zoneCreate = document.getElementById('zoneCreate');
  const zoneClear = document.getElementById('zoneClear');
  if (cToggleZones && cZonesGroup) {
    cToggleZones.addEventListener('click', () => {
      const isOpen = cZonesGroup.classList.contains('open');
      cZonesGroup.classList.toggle('open', !isOpen);
      cZonesGroup.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
      cToggleZones.setAttribute('aria-pressed', isOpen ? 'false' : 'true');
      // Toggle overall zones edit mode
      window.dispatchEvent(new CustomEvent('zones:edit', { detail: { on: !isOpen } }));
      if (isOpen) {
        // Reset child state when collapsing
        if (zoneCreate) zoneCreate.setAttribute('aria-pressed','false');
        window.dispatchEvent(new CustomEvent('zones:mode', { detail: { mode: 'idle' } }));
      }
    });
  }
  if (zoneColor) zoneColor.addEventListener('input', ()=> window.dispatchEvent(new CustomEvent('zones:color', { detail: { color: zoneColor.value } })));
  if (zoneCreate) zoneCreate.addEventListener('click', ()=> {
    const pressed = zoneCreate.getAttribute('aria-pressed') === 'true';
    const next = !pressed;
    zoneCreate.setAttribute('aria-pressed', next ? 'true' : 'false');
    window.dispatchEvent(new CustomEvent('zones:mode', { detail: { mode: next ? 'draw' : 'idle' } }));
  });
  if (zoneClear) zoneClear.addEventListener('click', ()=> { if (confirm('Clear all zones?')) window.dispatchEvent(new CustomEvent('zones:clear')); });
  </script>
</body>
</html>
