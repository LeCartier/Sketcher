<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#111111" />
  <title>Sketcher – Columbarium</title>
  <link rel="stylesheet" href="./css/styles.css" />
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:#111; color:#eee; }
  .btn { background:#1f6feb; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; font-size:13px; }
  .btn.secondary { background:#333; color:#ddd; }
  .btn:disabled { opacity:0.6; cursor:not-allowed; }
  /* Pannable grid canvas: fill viewport, prefer dynamic viewport units */
  #gridStage { position: fixed; top:0; left:0; width:100vw; height:100vh; z-index: 0; display: block; cursor: grab; }
  @supports (height: 100dvh) { #gridStage { width: 100dvw; height: 100dvh; } }
  #gridStage.grabbing { cursor: grabbing; }
  /* UI overlay for controls can stack above */
  .row { display:flex; gap:6px; }
    a.link { color:#9ecbff; text-decoration:none; }
    a.link:hover { text-decoration:underline; }
    /* Modal viewer */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:99; }
    .modal { width:min(92vw, 960px); height:min(82vh, 640px); background:#111; border:1px solid #333; border-radius:8px; overflow:hidden; display:flex; flex-direction:column; }
    .modal header { border-bottom:1px solid #333; }
    .modal main { flex:1; position:relative; }
    .canvas-wrap { position:absolute; inset:0; }
    .modal footer { border-top:1px solid #333; padding:8px; display:flex; justify-content:flex-end; gap:8px; }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "./js/vendor/three.module.js"
      }
    }
  </script>
</head>
<body class="columbarium">
  <div id="pageFade" aria-hidden="true"></div>
  <!-- Toolbox-like controls for Columbarium (consistent with editor) -->
  <div id="cToolbox">
    <div id="cTopIcons">
      <button id="cToggleImport" class="icon-btn toggle-btn" title="Import" aria-label="Import" aria-pressed="false">
      <span class="sr-only">Import</span>
      <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="#222" stroke-width="2"/><path d="M12 8v6" stroke="#222" stroke-width="2"/><path d="M9 14l3 3 3-3" fill="none" stroke="#222" stroke-width="2"/></svg>
      </button>
      <div id="cImportGroup" class="collapse" aria-hidden="true" style="width:100%;">
        <button id="importBtn" class="icon-btn" title="Import Scene JSON" aria-label="Import Scene JSON">
          <span class="sr-only">Import Scene JSON</span>
          <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="#222" stroke-width="2"/><path d="M12 8v6" stroke="#222" stroke-width="2"/><path d="M9 14l3 3 3-3" fill="none" stroke="#222" stroke-width="2"/></svg>
        </button>
        <input id="importInput" type="file" accept="application/json,.json,.gltf,.glb,.obj" style="display:none" />
      </div>
      <button id="cCenterView" class="icon-btn" title="Center View" aria-label="Center View">
      <span class="sr-only">Center View</span>
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="7" fill="none" stroke="#222" stroke-width="2"/><circle cx="12" cy="12" r="2" fill="#222"/></svg>
    </button>
      <!-- Zones tool -->
      <button id="cToggleZones" class="icon-btn toggle-btn" title="Zones" aria-label="Zones" aria-pressed="false">
      <span class="sr-only">Zones</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <!-- Transparent container box -->
        <rect x="3.5" y="3.5" width="17" height="17" rx="3" fill="none" stroke="#222" stroke-width="2"/>
        <!-- Solid color plus in top-left corner -->
        <g id="zonesParentPlus" fill="#ffbf00">
          <rect x="5" y="5" width="6" height="2" rx="1"/>
          <rect x="7" y="3" width="2" height="6" rx="1"/>
        </g>
      </svg>
    </button>
  </div>
    <div id="cZonesGroup" class="collapse" aria-hidden="true">
  <div class="row center">
        <button id="zoneCreate" class="icon-btn toggle-btn" title="Create Zone" aria-label="Create Zone" aria-pressed="false">
          <span class="sr-only">Create Zone</span>
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 5v14M5 12h14" stroke="#222" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
  <div class="row center" style="padding: 4px 0;">
        <input id="zoneColor" type="color" value="#ffbf00" title="Zone Color" aria-label="Zone Color" style="width:36px;height:36px;padding:0;border:none;background:none;box-shadow:0 1px 4px rgba(0,0,0,0.08);"/>
      </div>
  <div class="row end">
        <button id="zoneClear" class="icon-btn" title="Clear All Zones" aria-label="Clear All Zones">
          <span class="sr-only">Clear All Zones</span>
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <!-- Unified clear icon: square with an X -->
            <rect x="5" y="5" width="14" height="14" rx="2" fill="none" stroke="#222" stroke-width="2"/>
            <path d="M8 8l8 8M16 8l-8 8" stroke="#222" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
  <canvas id="gridStage" aria-label="Columbarium Grid"></canvas>
  <div class="page-vignette" aria-hidden="true"></div>
  <!-- Version badge (also triggers AnArch) -->
  <div id="version-badge" role="button" tabindex="0" title="About / AnArch" aria-label="About / AnArch" style="position:fixed; right:12px; bottom:12px; background:rgba(0,0,0,0.8); color:#fff; padding:6px 8px; border-radius:6px; font-family:sans-serif; font-size:12px; z-index:220; line-height:1; white-space:nowrap; box-shadow:0 2px 10px rgba(0,0,0,0.25); min-width: 96px; text-align:center; cursor:pointer; user-select:none;">
    v1.1.0
  </div>

  <div id="viewerBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h1 id="viewerTitle" style="font-size:16px; font-weight:600; margin:0;">Preview</h1>
      </header>
      <main>
        <div class="canvas-wrap"><canvas id="viewerCanvas"></canvas></div>
      </main>
      <footer>
        <button id="viewerClose" class="btn secondary">Close</button>
      </footer>
    </div>
  </div>

  <!-- Floating button back to editor - top-left for consistency -->
  <a id="toEditorFloating" class="floating-nav nav-top-right" href="./index.html" title="Back to Editor" aria-label="Back to Editor">
    <!-- Clean perspective grid icon -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <g fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round">
        <!-- Outer trapezoid (grid boundary) -->
        <path d="M9 8 L15 8 L20 18 L4 18 Z" stroke-width="1.4" opacity=".95"/>
        <!-- Horizontal grid lines (foreshortened) -->
        <path d="M8 10 H16" stroke-width="1.2" opacity=".9"/>
        <path d="M7 12 H17" stroke-width="1.1" opacity=".85"/>
        <path d="M6 14 H18" stroke-width="1.05" opacity=".8"/>
        <path d="M5 16 H19" stroke-width="1" opacity=".75"/>
        <!-- Vertical convergence lines to top center -->
        <path d="M4 18 L9 8" stroke-width="1" opacity=".8"/>
        <path d="M8 18 L11 8" stroke-width="1" opacity=".8"/>
        <path d="M12 18 L12 8" stroke-width="1" opacity=".8"/>
        <path d="M16 18 L13 8" stroke-width="1" opacity=".8"/>
        <path d="M20 18 L15 8" stroke-width="1" opacity=".8"/>
      </g>
    </svg>
  </a>
  <!-- Floating button to 2D Sketch (top-right cluster) -->
  <a id="toSketch2DFromCol" class="floating-nav nav-top-right-4" href="./sketch2d.html" title="2D Sketch" aria-label="2D Sketch">
    <!-- Flat grid icon to indicate 2D -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <g fill="none" stroke="#fff" stroke-width="1.8" opacity=".92">
        <rect x="4" y="4" width="16" height="16" rx="2"/>
        <path d="M4 12h16M12 4v16" opacity=".9"/>
      </g>
    </svg>
  </a>
  <!-- Floating button to Community (top-right cluster) -->
  <a id="toCommunity" class="floating-nav nav-top-right-2" href="./community.html" title="Community" aria-label="Community">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <g fill="none" stroke="#fff" stroke-width="1.8" opacity=".9">
        <path d="M8 3v18M16 3v18M3 8h18M3 16h18"/>
      </g>
      <rect x="8.9" y="8.9" width="6.2" height="6.2" fill="#ff00ff" opacity=".95"/>
    </svg>
  </a>
  <!-- Floating Information button (legend-style) -->
  <button id="toLegend" class="floating-nav nav-top-right-3" title="Information" aria-label="Information" type="button">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round">
        <circle cx="12" cy="12" r="9"/>
        <path d="M12 17v-6"/>
        <circle cx="12" cy="8" r="1" fill="#fff" stroke="none"/>
      </g>
    </svg>
  </button>
  <!-- Legend/Info popup for Personal Columbarium -->
  <div id="legendPopup" style="display:none; max-width: 520px; max-height: 70vh; overflow:auto; backdrop-filter: blur(6px);">
    <div class="legend-welcome">
      <h3>Personal Columbarium</h3>
      <div class="legend-tagline">Your private collection of saved scenes</div>
    </div>
    <div class="legend-section">
      <h4>Saving and Arranging</h4>
      <ul>
        <li>Save a scene from the Editor (Black grid under Columbarium Icon). It appears here as a tile.</li>
        <li>Drag tiles to arrange. Positions auto‑save.</li>
        <li>Click a tile to open a larger preview; open in Editor to continue working.</li>
      </ul>
    </div>
    <div class="legend-section">
      <h4>Trading from Community</h4>
      <ul>
        <li>Share to Community from the Editor (Magenta grid under the Columbarium Icon) to get a trade pick.</li>
        <li>Pick from 5 community scenes and your choice is added here automatically.</li>
        <li>New scenes auto‑place into the nearest free cell on this grid.</li>
      </ul>
    </div>
  </div>
  <script type="module">
    // Page fade-in/out
    document.addEventListener('DOMContentLoaded', () => {
      requestAnimationFrame(()=>document.body.classList.add('page-ready'));
  const hooks = [document.getElementById('toEditorFloating'), document.getElementById('toSketch2DFromCol')].filter(Boolean);
      hooks.forEach(el => el.addEventListener('click', (e) => {
        e.preventDefault();
        const href = el.getAttribute('href');
  document.body.classList.add('page-leave');
  setTimeout(()=>{ window.location.href = href; }, 170);
      }));
    });
  // Load modules: preview/import wiring and interactive grid
  import('./js/app/columbarium.js');
  import('./js/app/columbarium-grid.js');
  // Toolbox behavior
  const cToggleImport = document.getElementById('cToggleImport');
  const cImportGroup = document.getElementById('cImportGroup');
  if (cToggleImport && cImportGroup) {
    cToggleImport.addEventListener('click', () => {
      const isOpen = cImportGroup.classList.contains('open');
      cImportGroup.classList.toggle('open', !isOpen);
      cImportGroup.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
      cToggleImport.setAttribute('aria-pressed', isOpen ? 'false' : 'true');
    });
  }
  const cCenterView = document.getElementById('cCenterView');
  if (cCenterView) cCenterView.addEventListener('click', ()=> window.dispatchEvent(new CustomEvent('columbarium:center')));
  // Fade nav to community
  const toCommunity = document.getElementById('toCommunity');
  if (toCommunity) toCommunity.addEventListener('click', (e)=>{ e.preventDefault(); const href=toCommunity.getAttribute('href'); document.body.classList.add('page-leave'); setTimeout(()=>{ window.location.href = href; }, 170); });
  // Zones toolbox wiring
  const cToggleZones = document.getElementById('cToggleZones');
  const cZonesGroup = document.getElementById('cZonesGroup');
  const zoneColor = document.getElementById('zoneColor');
  const zoneCreate = document.getElementById('zoneCreate');
  const zoneClear = document.getElementById('zoneClear');
  if (cToggleZones && cZonesGroup) {
    cToggleZones.addEventListener('click', () => {
      const isOpen = cZonesGroup.classList.contains('open');
      cZonesGroup.classList.toggle('open', !isOpen);
      cZonesGroup.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
      cToggleZones.setAttribute('aria-pressed', isOpen ? 'false' : 'true');
      // Toggle overall zones edit mode
      window.dispatchEvent(new CustomEvent('zones:edit', { detail: { on: !isOpen } }));
      if (isOpen) {
        // Reset child state when collapsing
        if (zoneCreate) zoneCreate.setAttribute('aria-pressed','false');
        window.dispatchEvent(new CustomEvent('zones:mode', { detail: { mode: 'idle' } }));
      }
    });
  }
  // Version badge: set text and trigger AnArch on click/keyboard
  (async () => {
    try {
      const res = await fetch('./version.json', { cache: 'no-store' });
      if (res.ok) {
        const v = await res.json();
        const el = document.getElementById('version-badge');
        if (el) el.textContent = `v${v.version} — ${v.date}`;
      }
    } catch {}
    try {
      const mod = await import('./js/app/anarch.js');
      const badge = document.getElementById('version-badge');
      if (mod && mod.triggerAnArchSequence && badge) {
        const run = () => { try { mod.triggerAnArchSequence(); } catch {} };
        badge.addEventListener('click', run);
        badge.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); run(); } });
      }
    } catch {}
  })();
  if (zoneColor) zoneColor.addEventListener('input', ()=> window.dispatchEvent(new CustomEvent('zones:color', { detail: { color: zoneColor.value } })));
  if (zoneCreate) zoneCreate.addEventListener('click', ()=> {
    const pressed = zoneCreate.getAttribute('aria-pressed') === 'true';
    const next = !pressed;
    zoneCreate.setAttribute('aria-pressed', next ? 'true' : 'false');
    window.dispatchEvent(new CustomEvent('zones:mode', { detail: { mode: next ? 'draw' : 'idle' } }));
  });
  if (zoneClear) zoneClear.addEventListener('click', ()=> { if (confirm('Clear all zones?')) window.dispatchEvent(new CustomEvent('zones:clear')); });
  // Info/Legend button behavior (match editor)
  const toLegend = document.getElementById('toLegend');
  const legendPopup = document.getElementById('legendPopup');
  if (toLegend && legendPopup) {
    const placePopup = () => {
      const btnRect = toLegend.getBoundingClientRect();
      const popup = legendPopup;
      const left = Math.max(12, Math.min(btnRect.right - popup.offsetWidth, window.innerWidth - popup.offsetWidth - 12));
      const top = Math.min(btnRect.bottom + 10, window.innerHeight - popup.offsetHeight - 12);
      popup.style.left = left + 'px';
      popup.style.top = top + 'px';
    };
    const openPopup = () => {
      legendPopup.style.display = 'block';
      requestAnimationFrame(()=>{ placePopup(); legendPopup.classList.add('open'); });
    };
    const closePopup = () => {
      legendPopup.classList.remove('open');
      setTimeout(()=>{ legendPopup.style.display = 'none'; }, 180);
    };
    toLegend.addEventListener('click', (e)=>{
      e.stopPropagation();
      const isOpen = legendPopup.classList.contains('open');
      if (isOpen) closePopup(); else openPopup();
    });
    document.addEventListener('click', (e)=>{
      if (!legendPopup.contains(e.target) && e.target !== toLegend) {
        if (legendPopup.classList.contains('open')) closePopup();
      }
    });
    window.addEventListener('resize', ()=>{ if (legendPopup.classList.contains('open')) placePopup(); });
  }
  </script>
</body>
</html>
