<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0f0f0f" />
  <title>Sketcher – Community</title>
  <link rel="stylesheet" href="./css/styles.css" />
  <script type="importmap">
    { "imports": { "three": "./js/vendor/three.module.js" } }
  </script>
  <style>
    body { background:#0f0f0f; color:#eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  /* Canvas grid like personal columbarium */
  #communityGridStage { position: fixed; top:0; left:0; width:100vw; height:100vh; z-index: 0; display: block; cursor: grab; touch-action: none; overscroll-behavior: none; }
  @supports (height: 100dvh) { #communityGridStage { width: 100dvw; height: 100dvh; } }
  #communityGridStage.grabbing { cursor: grabbing; }
    .card { position: relative; background: rgba(20,20,20,0.98); border:1px solid #2a2a2a; border-radius: 14px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); overflow: hidden; }
    .card .thumb { width: 100%; aspect-ratio: 1 / 1; background:#222; display:block; object-fit: cover; }
    .card .meta { position:absolute; left:0; right:0; bottom:0; padding:10px; background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.55) 100%); color:#fff; display:flex; gap:8px; align-items:center; }
    .card .title { font: 600 13px system-ui, sans-serif; margin-right: auto; text-shadow: 0 2px 6px rgba(0,0,0,0.6); }
    .card button { background:#333; color:#ddd; border:1px solid rgba(255,255,255,0.16); padding:6px 10px; border-radius:8px; cursor:pointer; }
    .topbar { position: fixed; left: 20px; right: 20px; top: 20px; display:flex; gap:10px; align-items:center; z-index: 120; }
    .topbar .pill { background: rgba(24,24,24,0.9); border:1px solid #2a2a2a; color:#fff; padding:8px 12px; border-radius:12px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); display:flex; gap:10px; align-items:center; }
    .choices { display:flex; gap:12px; }
    .choice { width: 160px; height: 160px; border-radius: 12px; overflow:hidden; border:1px solid #2a2a2a; position: relative; }
    .choice img { width:100%; height:100%; object-fit: cover; display:block; }
    .choice .pick { position:absolute; left:6px; bottom:6px; right:6px; display:flex; justify-content: center; }
  .choice .pick button { width: 100%; background:#333; color:#ddd; border:1px solid rgba(255,255,255,0.16); padding:6px 10px; border-radius:8px; cursor:pointer; }
  /* Secret Space access button and panel */
  #secretAccessBtn { background: rgba(24,24,24,0.9); border:1px solid #2a2a2a; color:#fff; padding:8px 12px; border-radius:12px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); cursor:pointer; }
  #secretAccessBtn[aria-pressed="true"] { outline: 1px solid rgba(255,0,255,0.6); }
  #secretPanel { position: fixed; top: 20px; right: 20px; width: min(380px, 92vw); max-height: calc(100vh - 40px); overflow: auto; background: rgba(20,20,20,0.98); border:1px solid #2a2a2a; border-radius: 12px; z-index: 140; display: none; }
  #secretPanel.open { display: block; }
  #secretPanel header { position: sticky; top: 0; background: rgba(20,20,20,0.98); padding: 10px 12px; border-bottom: 1px solid #2a2a2a; display:flex; align-items:center; gap:8px; }
  #secretPanel header .title { font: 600 14px system-ui, sans-serif; color:#fff; margin-right:auto; }
  #secretPanel header .tag { background: rgba(255,0,255,0.9); color:#111; padding: 3px 8px; border-radius: 999px; border:1px solid rgba(0,0,0,0.35); font: 600 11px system-ui, sans-serif; }
  #secretList { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
  .secret-card { background: #161616; border:1px solid #2a2a2a; border-radius: 10px; overflow: hidden; }
  .secret-card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; background:#222; }
  .secret-card .meta { padding: 8px; display:flex; align-items:center; gap:6px; }
  .secret-card .name { font: 600 12px system-ui, sans-serif; color:#eee; margin-right:auto; }
  .secret-card button { background:#333; color:#ddd; border:1px solid rgba(255,255,255,0.16); padding:6px 10px; border-radius:8px; cursor:pointer; }
  </style>
</head>
<body class="community">
  <div id="pageFade" aria-hidden="true"></div>
  <!-- Toolbox-style controls (match personal columbarium) -->
  <div id="cToolbox">
    <div id="cTopIcons">
      <button id="cCenterView" class="icon-btn" title="Center View" aria-label="Center View" type="button">
        <span class="sr-only">Center View</span>
        <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="7" fill="none" stroke="#222" stroke-width="2"/><circle cx="12" cy="12" r="2" fill="#222"/></svg>
      </button>
  <button id="secretAccessBtn" type="button" aria-pressed="false" title="Secret Space Access" aria-label="Secret Space">
        <!-- Lightbulb icon will be injected/managed by JS -->
      </button>
    </div>
  </div>
  <canvas id="communityGridStage" aria-label="Community Grid"></canvas>
  <div class="page-vignette" aria-hidden="true"></div>

  <!-- Secret Space right-side panel -->
  <aside id="secretPanel" aria-label="Secret Space Panel">
    <header>
      <div class="title">Secret Space</div>
      <div class="tag">Private</div>
      <button id="secretClose" title="Close" aria-label="Close" type="button" style="background:#333; color:#ddd; border:1px solid rgba(255,255,255,0.16); padding:6px 10px; border-radius:8px; cursor:pointer;">×</button>
    </header>
    <div id="secretList" role="list"></div>
  </aside>

  <!-- Version badge (also triggers AnArch) -->
  <div id="version-badge" role="button" tabindex="0" title="About / AnArch" aria-label="About / AnArch" style="position:fixed; right:12px; bottom:12px; background:rgba(0,0,0,0.8); color:#fff; padding:6px 8px; border-radius:6px; font-family:sans-serif; font-size:12px; z-index:220; line-height:1; white-space:nowrap; box-shadow:0 2px 10px rgba(0,0,0,0.25); min-width: 96px; text-align:center; cursor:pointer; user-select:none;">
    v2.0.0
  </div>

  <a id="toColumbariumBack" class="floating-nav nav-top-right" href="./columbarium.html" title="Back to Columbarium" aria-label="Back to Columbarium">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <g fill="none" stroke="#fff" stroke-width="1.8">
        <path d="M8 3v18M16 3v18M3 8h18M3 16h18"/>
      </g>
  <rect x="8.9" y="8.9" width="6.2" height="6.2" fill="#fff" opacity=".85"/>
    </svg>
  </a>
  <!-- Direct nav to Editor (placed next to Columbarium button) -->
  <a id="toEditor" class="floating-nav nav-top-right-2" href="./index.html" title="Back to Editor" aria-label="Back to Editor">
    <!-- Perspective grid icon (matches editor button used elsewhere) -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <g fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 8 L15 8 L20 18 L4 18 Z" stroke-width="1.4" opacity=".95"/>
        <path d="M8 10 H16" stroke-width="1.2" opacity=".9"/>
        <path d="M7 12 H17" stroke-width="1.1" opacity=".85"/>
        <path d="M6 14 H18" stroke-width="1.05" opacity=".8"/>
        <path d="M5 16 H19" stroke-width="1" opacity=".75"/>
        <path d="M4 18 L9 8" stroke-width="1" opacity=".8"/>
        <path d="M8 18 L11 8" stroke-width="1" opacity=".8"/>
        <path d="M12 18 L12 8" stroke-width="1" opacity=".8"/>
        <path d="M16 18 L13 8" stroke-width="1" opacity=".8"/>
        <path d="M20 18 L15 8" stroke-width="1" opacity=".8"/>
      </g>
    </svg>
  </a>
  <!-- Floating Information button (legend-style) -->
  <button id="toLegend" class="floating-nav nav-top-right-3" title="Information" aria-label="Information" type="button">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round">
        <circle cx="12" cy="12" r="9"/>
        <path d="M12 17v-6"/>
        <circle cx="12" cy="8" r="1" fill="#fff" stroke="none"/>
      </g>
    </svg>
  </button>
  <!-- Floating Sources button -->
  <button id="toSources" class="floating-nav nav-top-right-4" title="Sources" aria-label="Sources" type="button">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <!-- Simple database cylinder icon -->
      <g fill="none" stroke="#fff" stroke-width="1.8">
        <ellipse cx="12" cy="6" rx="6" ry="3"/>
        <path d="M6 6v8c0 1.66 2.69 3 6 3s6-1.34 6-3V6"/>
        <path d="M6 10c0 1.66 2.69 3 6 3s6-1.34 6-3"/>
      </g>
    </svg>
  </button>
  <!-- Legend/Info popup for Community page -->
  <div id="legendPopup" style="display:none; max-width: 520px; max-height: 70vh; overflow:auto; backdrop-filter: blur(6px);">
    <div class="legend-welcome">
      <h3>Community Columbarium</h3>
      <div class="legend-tagline">Share snapshots, trade for inspiration</div>
    </div>
    <div class="legend-section">
      <h4>Sharing</h4>
      <ul>
        <li>From the Editor, choose Share to Community Columbarium to publish a scene.</li>
        <li>Only the latest 20 community scenes are kept.</li>
      </ul>
    </div>
    <div class="legend-section">
      <h4>Trade Flow</h4>
      <ul>
        <li>After sharing, you’ll get 5 random community picks to choose from. Highlighted in orange.</li>
        <li>Picking adds that scene to your personal columbarium automatically.</li>
        <li>In your Columbarium, the scene is placed in the closest free cell.</li>
      </ul>
    </div>
  </div>

  <!-- Sources popup (like legend) -->
  <div id="sourcesPopup" style="display:none; max-width: 520px; max-height: 70vh; overflow:auto; backdrop-filter: blur(6px);
    background: rgba(24,24,24,0.92); color:#eee; border:1px solid #2a2a2a; border-radius:12px; box-shadow: 0 12px 28px rgba(0,0,0,0.45); position: fixed; z-index: 210; padding: 10px;">
    <!-- Content rendered by sources.js -->
  </div>

  <script type="module">
    // Fade-in/out and nav
    document.addEventListener('DOMContentLoaded', () => {
      requestAnimationFrame(()=>document.body.classList.add('page-ready'));
      const link = document.getElementById('toColumbariumBack');
      if (link) link.addEventListener('click', (e) => { e.preventDefault(); const href = link.getAttribute('href'); document.body.classList.add('page-leave'); setTimeout(()=>{ window.location.href = href; }, 170); });
      const toEditor = document.getElementById('toEditor');
      if (toEditor) toEditor.addEventListener('click', (e) => { e.preventDefault(); const href = toEditor.getAttribute('href'); document.body.classList.add('page-leave'); setTimeout(()=>{ window.location.href = href; }, 170); });
  const cCenter = document.getElementById('cCenterView');
  if (cCenter) cCenter.addEventListener('click', ()=> window.dispatchEvent(new CustomEvent('community:center')));
    });
  // Start the canvas-based community grid and preview overlay wiring
  import('./js/app/community-grid.js');
  import('./js/app/community.js');
  import('./js/app/secret-panel.js');
  let sourcesMod = null;
  import('./js/app/ui/sources.js').then(mod => { sourcesMod = mod; if (mod && mod.attachFloating) mod.attachFloating(); }).catch(()=>{});
  // Version badge text + AnArch easter egg
  (async () => {
    try {
      const res = await fetch('./version.json', { cache: 'no-store' });
      if (res.ok) {
        const v = await res.json();
        const el = document.getElementById('version-badge');
        if (el) el.textContent = `v${v.version} — ${v.date}`;
      }
    } catch {}
    try {
      const mod = await import('./js/app/anarch.js');
      const badge = document.getElementById('version-badge');
      if (mod && mod.triggerAnArchSequence && badge) {
        const run = () => { try { mod.triggerAnArchSequence(); } catch {} };
        badge.addEventListener('click', run);
        badge.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); run(); } });
      }
    } catch {}
  })();
  // Info/Legend button behavior (match editor)
  const toLegend = document.getElementById('toLegend');
  const legendPopup = document.getElementById('legendPopup');
  if (toLegend && legendPopup) {
    const placePopup = () => {
      const btnRect = toLegend.getBoundingClientRect();
      const popup = legendPopup;
      const left = Math.max(12, Math.min(btnRect.right - popup.offsetWidth, window.innerWidth - popup.offsetWidth - 12));
      const top = Math.min(btnRect.bottom + 10, window.innerHeight - popup.offsetHeight - 12);
      popup.style.left = left + 'px';
      popup.style.top = top + 'px';
    };
    const openPopup = () => {
      legendPopup.style.display = 'block';
      requestAnimationFrame(()=>{ placePopup(); legendPopup.classList.add('open'); });
    };
    const closePopup = () => {
      legendPopup.classList.remove('open');
      setTimeout(()=>{ legendPopup.style.display = 'none'; }, 180);
    };
    toLegend.addEventListener('click', (e)=>{
      e.stopPropagation();
      const isOpen = legendPopup.classList.contains('open');
      if (isOpen) closePopup(); else openPopup();
    });
    document.addEventListener('click', (e)=>{
      if (!legendPopup.contains(e.target) && e.target !== toLegend) {
        if (legendPopup.classList.contains('open')) closePopup();
      }
    });
    window.addEventListener('resize', ()=>{ if (legendPopup.classList.contains('open')) placePopup(); });
  }

  // Sources popup behavior (matches legend positioning)
  const toSources = document.getElementById('toSources');
  const sourcesPopup = document.getElementById('sourcesPopup');
  if (toSources && sourcesPopup) {
    const place = () => {
      const btnRect = toSources.getBoundingClientRect();
      const left = Math.max(12, Math.min(btnRect.right - sourcesPopup.offsetWidth, window.innerWidth - sourcesPopup.offsetWidth - 12));
      const top = Math.min(btnRect.bottom + 10, window.innerHeight - sourcesPopup.offsetHeight - 12);
      sourcesPopup.style.left = left + 'px'; sourcesPopup.style.top = top + 'px';
    };
    const open = async () => {
      sourcesPopup.style.display = 'block';
      if (sourcesMod && sourcesMod.renderInto) { try { await sourcesMod.renderInto(sourcesPopup); } catch {} }
      requestAnimationFrame(()=>{ place(); sourcesPopup.classList.add('open'); });
    };
    const close = () => { sourcesPopup.classList.remove('open'); setTimeout(()=>{ sourcesPopup.style.display = 'none'; }, 180); };
    toSources.addEventListener('click', async (e)=>{ e.stopPropagation(); const isOpen = sourcesPopup.classList.contains('open'); if (isOpen) close(); else await open(); });
    document.addEventListener('click', (e)=>{ if (!sourcesPopup.contains(e.target) && e.target !== toSources) { if (sourcesPopup.classList.contains('open')) close(); } });
    window.addEventListener('resize', ()=>{ if (sourcesPopup.classList.contains('open')) place(); });
    window.addEventListener('sources:active-changed', ()=>{ if (sourcesPopup.classList.contains('open') && sourcesMod && sourcesMod.renderInto) sourcesMod.renderInto(sourcesPopup); });
  }
  </script>
</body>
</html>
