<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#1e1e1e" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1e1e1e" />
  <title>Sketcher</title>
  <link rel="stylesheet" href="./css/styles.css" />
</head>
<body>
  <div id="pageFade" aria-hidden="true"></div>
  <script type="importmap">
    {
      "imports": {
        "three": "./js/vendor/three.module.js"
      }
    }
  </script>
  <div id="ui-container">
  <div id="modePanel" style="display:none;" aria-hidden="true">
      <label for="modeSelect" data-i18n="mode.label">Mode:</label>
      <select id="modeSelect">
        <option value="edit" selected data-i18n="mode.edit">Edit</option>
        <option value="ar" data-i18n="mode.ar">AR View</option>
      </select>
    </div>
  <div id="edit-ui" style="margin-top:6px; display:none;"></div>
    <button id="arButton" style="margin-top:10px; display:none;" data-i18n="buttons.enterAR">Enter AR</button>
  <!-- Removed export scene button from main UI panel; now only in Utilities group -->
  <!-- Instructions removed -->
    <!-- ...existing code... -->
  <!-- ...existing code... -->
    
  <input id="modelInput" type="file" accept=".gltf,.glb,.obj,.rvt" style="display:none;">
  </div>
  <!-- Popup showing the model currently being placed (appears next to the toolbox) -->
  <div id="placingPopup" role="status" aria-live="polite" aria-atomic="true" style="display:none;">
    <div class="placing-title">Placing</div>
    <div id="placingName" class="placing-name">…</div>
    <button id="placingCancel" class="placing-cancel" title="Cancel placement" aria-label="Cancel placement" type="button">×</button>
  </div>
  <div id="toolbox">
    <!-- 1) Click-Drag Create -->
    <button id="toggleDrawCreate" class="icon-btn toggle-btn" title="Click-Drag Create" aria-label="Click-Drag Create" aria-pressed="false">
      <span class="sr-only">Click-Drag Create</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <!-- Collection of shapes: square, circle, triangle -->
        <rect x="3" y="13" width="7" height="7" fill="none" stroke="#222" stroke-width="2"/>
        <circle cx="16" cy="8" r="3" fill="none" stroke="#222" stroke-width="2"/>
        <polygon points="12,14 20,20 12,20" fill="none" stroke="#222" stroke-width="2"/>
      </svg>
    </button>
    <div id="drawCreateGroup" class="collapse" aria-hidden="true">
      <button id="dcBox" class="icon-btn" title="Box (drag)" aria-label="Box (drag)">
        <span class="sr-only">Box (drag)</span>
        <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="5" y="5" width="14" height="14" fill="none" stroke="#222" stroke-width="2"/></svg>
      </button>
      <button id="dcSphere" class="icon-btn" title="Sphere (drag)" aria-label="Sphere (drag)">
        <span class="sr-only">Sphere (drag)</span>
        <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="7" fill="none" stroke="#222" stroke-width="2"/></svg>
      </button>
      <button id="dcCylinder" class="icon-btn" title="Cylinder (drag)" aria-label="Cylinder (drag)">
        <span class="sr-only">Cylinder (drag)</span>
        <svg viewBox="0 0 24 24" aria-hidden="true"><ellipse cx="12" cy="6" rx="6" ry="2" fill="none" stroke="#222" stroke-width="2"/><path d="M6 6v12m12-12v12" stroke="#222" stroke-width="2"/><ellipse cx="12" cy="18" rx="6" ry="2" fill="none" stroke="#222" stroke-width="2"/></svg>
      </button>
      <button id="dcCone" class="icon-btn" title="Cone (drag)" aria-label="Cone (drag)">
        <span class="sr-only">Cone (drag)</span>
        <svg viewBox="0 0 24 24" aria-hidden="true"><polygon points="12,4 4,18 20,18" fill="none" stroke="#222" stroke-width="2"/></svg>
      </button>
    </div>

    <!-- 2) Primitives -->
    <button id="togglePrims" class="icon-btn toggle-btn" title="Primitives" aria-label="Primitives" aria-pressed="false">
      <span class="sr-only">Primitives</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <!-- House icon: roof and body -->
        <polygon points="3,11 12,4 21,11" fill="none" stroke="#222" stroke-width="2"/>
        <rect x="6" y="11" width="12" height="9" fill="none" stroke="#222" stroke-width="2"/>
        <rect x="11" y="14" width="2" height="6" fill="none" stroke="#222" stroke-width="2"/>
      </svg>
    </button>
    <div id="primsGroup" class="collapse" aria-hidden="true">
      <button id="addFloor" class="icon-btn" title="Add Floor" aria-label="Add Floor">
        <span class="sr-only">Add Floor</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="5" y="5" width="14" height="14" fill="none" stroke="#222" stroke-width="2" rx="2" ry="2" />
        </svg>
      </button>
      <button id="addWall" class="icon-btn" title="Add Wall" aria-label="Add Wall">
        <span class="sr-only">Add Wall</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="9" y="4" width="6" height="12" fill="#999" stroke="#222" stroke-width="1.5" />
          <line x1="4" y1="19" x2="20" y2="19" stroke="#222" stroke-width="2" />
        </svg>
      </button>
      <button id="addColumn" class="icon-btn" title="Add Column" aria-label="Add Column">
        <span class="sr-only">Add Column</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <!-- Fluted column: capital, shaft (flutes), and base -->
          <rect x="6" y="4.5" width="12" height="2.5" fill="none" stroke="#222" stroke-width="1.8"/>
          <rect x="6" y="17" width="12" height="2.5" fill="none" stroke="#222" stroke-width="1.8"/>
          <line x1="9" y1="7.5" x2="9" y2="17" stroke="#222" stroke-width="1.6" stroke-linecap="round"/>
          <line x1="12" y1="7.5" x2="12" y2="17" stroke="#222" stroke-width="1.6" stroke-linecap="round"/>
          <line x1="15" y1="7.5" x2="15" y2="17" stroke="#222" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      </button>
      <button id="addBeam" class="icon-btn" title="Add Beam" aria-label="Add Beam">
        <span class="sr-only">Add Beam</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <!-- I-beam profile: top flange, web, bottom flange -->
          <rect x="4" y="7.5" width="16" height="2.5" fill="none" stroke="#222" stroke-width="1.8"/>
          <rect x="10" y="10" width="4" height="4" fill="none" stroke="#222" stroke-width="1.8"/>
          <rect x="4" y="14.5" width="16" height="2.5" fill="none" stroke="#222" stroke-width="1.8"/>
        </svg>
      </button>
      <button id="addRamp" class="icon-btn" title="Add Ramp" aria-label="Add Ramp">
        <span class="sr-only">Add Ramp</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <polygon points="3,16 21,12 21,16 3,16" fill="#bbb" stroke="#222" stroke-width="1.5"/>
        </svg>
      </button>
      <button id="addStairs" class="icon-btn" title="Add Stairs" aria-label="Add Stairs">
        <span class="sr-only">Add Stairs</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 18h4v-2h4v-2h4v-2h4v-2" fill="none" stroke="#222" stroke-width="1.8"/>
        </svg>
      </button>
      <button id="addRoof" class="icon-btn" title="Add Roof Plane" aria-label="Add Roof Plane">
        <span class="sr-only">Add Roof Plane</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <polygon points="3,12 12,6 21,12 21,14 3,14" fill="none" stroke="#222" stroke-width="1.8"/>
        </svg>
      </button>
    </div>

    <!-- 3) Scale Figure -->
    <button id="addScaleFigure" class="icon-btn" title="Add 6ft Scale Figure" aria-label="Add 6ft Scale Figure">
      <span class="sr-only">Add 6ft Scale Figure</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
  <circle cx="12" cy="5.5" r="2.6" fill="#222"/>
  <rect x="10.5" y="8" width="3" height="7.2" fill="#999" stroke="#222" stroke-width="1.4"/>
  <line x1="12" y1="15.2" x2="7.8" y2="20" stroke="#222" stroke-width="1.8"/>
  <line x1="12" y1="15.2" x2="16.2" y2="20" stroke="#222" stroke-width="1.8"/>
  <line x1="12" y1="10.8" x2="7.8" y2="13.6" stroke="#222" stroke-width="1.8"/>
  <line x1="12" y1="10.8" x2="16.2" y2="13.6" stroke="#222" stroke-width="1.8"/>
      </svg>
    </button>


  <!-- 8) Utilities (now below Scene Manager) -->
    <button id="toggleUtils" class="icon-btn toggle-btn" title="Utilities" aria-label="Utilities" aria-pressed="false">
      <span class="sr-only">Utilities</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <rect x="3" y="9" width="18" height="10" rx="2" ry="2" fill="none" stroke="#222" stroke-width="2"/>
        <rect x="8" y="6" width="8" height="3" rx="1.5" ry="1.5" fill="none" stroke="#222" stroke-width="2"/>
        <path d="M8 9V7m8 2V7" stroke="#222" stroke-width="2"/>
      </svg>
    </button>
  <div id="utilsGroup" class="collapse" aria-hidden="true">
      <button id="toolSnapFloor" class="icon-btn" title="Return to Floor" aria-label="Return to Floor">
        <span class="sr-only">Return to Floor</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <line x1="4" y1="20" x2="20" y2="20" stroke="#222" stroke-width="2"/>
          <line x1="12" y1="8" x2="12" y2="16" stroke="#222" stroke-width="2"/>
          <polyline points="9,13 12,16 15,13" fill="none" stroke="#222" stroke-width="2"/>
        </svg>
      </button>
      <button id="toolGroupSelected" class="icon-btn" title="Group Selected" aria-label="Group Selected">
        <span class="sr-only">Group Selected</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="8" width="6" height="6" fill="none" stroke="#222" stroke-width="2"/>
          <rect x="14" y="8" width="6" height="6" fill="none" stroke="#222" stroke-width="2"/>
          <path d="M7 11h10" stroke="#222" stroke-width="2"/>
        </svg>
      </button>
      <button id="centerOverlay" class="icon-btn" title="Return sketch to center" aria-label="Return sketch to center">
        <span class="sr-only">Return sketch to center</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <!-- Four arrows pointing toward the center -->
          <g fill="none" stroke="#222" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <!-- Top arrow down -->
            <path d="M12 3v6"/>
            <polyline points="9,7 12,10 15,7"/>
            <!-- Bottom arrow up -->
            <path d="M12 21v-6"/>
            <polyline points="9,17 12,14 15,17"/>
            <!-- Left arrow right -->
            <path d="M3 12h6"/>
            <polyline points="7,9 10,12 7,15"/>
            <!-- Right arrow left -->
            <path d="M21 12h-6"/>
            <polyline points="17,9 14,12 17,15"/>
          </g>
        </svg>
      </button>
      <button id="exportScene" class="icon-btn" title="Export Scene (OBJ)" aria-label="Export Scene (OBJ)">
        <span class="sr-only">Export Scene (OBJ)</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="#222" stroke-width="2"/>
          <!-- Down arrow to denote export/download -->
          <path d="M12 8v6" stroke="#222" stroke-width="2"/>
          <path d="M9 14l3 3 3-3" fill="none" stroke="#222" stroke-width="2"/>
        </svg>
      </button>
      <button id="exportRevitFamily" class="icon-btn" title="Export Revit Family (guide)" aria-label="Export Revit Family (guide)">
        <span class="sr-only">Export Revit Family (guide)</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <!-- Simplified RFA icon: R letter in a box -->
          <rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="#222" stroke-width="2"/>
          <text x="12" y="16" text-anchor="middle" font-size="10" fill="#222" font-family="Arial" font-weight="bold">RFA</text>
        </svg>
      </button>
      
  </div>

    <!-- Scene Manager parent button and group -->
    <button id="toggleSceneManager" class="icon-btn toggle-btn" title="Scene Manager" aria-label="Scene Manager" aria-pressed="false">
      <span class="sr-only">Scene Manager</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <!-- Tic-tac-toe grid with one filled square -->
        <g fill="none" stroke="#222" stroke-width="1.8">
          <path d="M8 3v18M16 3v18M3 8h18M3 16h18"/>
        </g>
  <rect x="8.9" y="8.9" width="6.2" height="6.2" fill="#222"/>
      </svg>
    </button>
    <div id="sceneManagerGroup" class="collapse" aria-hidden="true">
      <button id="newScene" class="icon-btn" title="New Scene" aria-label="New Scene">
        <span class="sr-only">New Scene</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="#222" stroke-width="2"/>
          <path d="M12 8v8" stroke="#222" stroke-width="2"/>
          <path d="M8 12h8" stroke="#222" stroke-width="2"/>
        </svg>
      </button>
      <button id="saveScene" class="icon-btn" title="Save Scene" aria-label="Save Scene">
        <span class="sr-only">Save Scene</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <!-- Personal columbarium: tic-tac-toe with black center + up arrow -->
          <g fill="none" stroke="#222" stroke-width="1.8">
            <path d="M8 3v18M16 3v18M3 8h18M3 16h18"/>
          </g>
          <!-- Filled black center square -->
          <rect x="8.9" y="8.9" width="6.2" height="6.2" fill="#222"/>
          <!-- Up arrow next to grid (right side) -->
          <path d="M22.3 21V9" stroke="#222" stroke-width="2" stroke-linecap="round"/>
          <path d="M22.3 3 L19 9 L24 9 Z" fill="#222"/>
        </svg>
      </button>
      <button id="shareToCommunity" class="icon-btn" title="Share to Community" aria-label="Share to Community">
        <span class="sr-only">Share to Community</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <!-- Community columbarium: tic-tac-toe with magenta center + up arrow -->
          <g fill="none" stroke="#222" stroke-width="1.8">
            <path d="M8 3v18M16 3v18M3 8h18M3 16h18"/>
          </g>
          <!-- Filled magenta center square -->
          <rect x="8.9" y="8.9" width="6.2" height="6.2" fill="#ff00ff" opacity="0.95"/>
          <!-- Up arrow next to grid (right side) -->
          <path d="M22.3 21V9" stroke="#222" stroke-width="2" stroke-linecap="round"/>
          <path d="M22.3 3 L19 9 L24 9 Z" fill="#222"/>
        </svg>
      </button>
  <!-- My Scenes moved to Columbarium → load UI removed on main page -->
    </div>

    <!-- 5) Import (moved above Settings) -->
    <button id="toggleImport" class="icon-btn toggle-btn" title="Import" aria-label="Import" aria-pressed="false">
      <span class="sr-only">Import</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="#222" stroke-width="2"/>
        <path d="M12 8v6" stroke="#222" stroke-width="2"/>
        <path d="M9 14l3 3 3-3" fill="none" stroke="#222" stroke-width="2"/>
      </svg>
    </button>
    <div id="importGroup" class="collapse" aria-hidden="true">
      <button id="uploadModel" class="icon-btn" title="Upload Model" aria-label="Upload Model">
        <span class="sr-only">Upload Model</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="#222" stroke-width="2"/>
          <!-- Up arrow to denote upload/import -->
          <path d="M12 16V10" stroke="#222" stroke-width="2"/>
          <path d="M9 10l3-3 3 3" fill="none" stroke="#222" stroke-width="2"/>
        </svg>
      </button>
      <button id="mapImport" class="icon-btn" title="Import from Map" aria-label="Import from Map">
        <span class="sr-only">Import from Map</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 6l6-2 6 2 6-2v14l-6 2-6-2-6 2V6z" fill="none" stroke="#222" stroke-width="1.8"/>
          <!-- Up arrow badge to denote import -->
          <path d="M12 16V10" stroke="#222" stroke-width="2"/>
          <path d="M9 10l3-3 3 3" fill="none" stroke="#222" stroke-width="2"/>
        </svg>
      </button>
    </div>

    <!-- 9) Settings -->
    <button id="toggleSettings" class="icon-btn toggle-btn" title="Settings" aria-label="Settings" aria-pressed="false">
      <span class="sr-only">Settings</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <!-- Gear icon -->
        <g fill="none" stroke="#222" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19.4 12.94a7.5 7.5 0 0 0 0-1.88l2.02-1.57a.6.6 0 0 0 .14-.78l-1.91-3.3a.6.6 0 0 0-.73-.27l-2.38.96a7.6 7.6 0 0 0-1.62-.94l-.36-2.54A.6.6 0 0 0 14 .8h-3.82a.6.6 0 0 0-.59.49l-.36 2.54c-.57.23-1.12.53-1.62.94l-2.38-.96a.6.6 0 0 0-.73.27l-1.91 3.3a.6.6 0 0 0 .14.78L4.6 11.06a7.5 7.5 0 0 0 0 1.88l-2.02 1.57a.6.6 0 0 0-.14.78l1.91 3.3c.13.22.4.32.64.23l2.38-.96c.5.41 1.05.72 1.62.94l.36 2.54c.05.29.3.49.59.49H14c.29 0 .54-.2.59-.49l.36-2.54c.57-.23 1.12-.53 1.62-.94l2.38.96c.24.09.51-.01.64-.23l1.91-3.3a.6.6 0 0 0-.14-.78l-2.02-1.57z"/>
          <circle cx="12" cy="12" r="3.5"/>
        </g>
      </svg>
    </button>
    <div id="settingsGroup" class="collapse" aria-hidden="true">
  <label style="display:block; margin-bottom:8px; font-size:13px; color:#222; text-align:center;">Back Color
        <input id="bgColorPicker" type="color" value="#1e1e1e" style="margin-left:8px;">
      </label>
  <label style="display:block; margin-bottom:8px; font-size:13px; color:#222; text-align:center;">Grid Color
        <input id="gridColorPicker" type="color" value="#ffffff" style="margin-left:8px;">
      </label>
  <div style="display:block; margin-bottom:8px; font-size:13px; color:#222; text-align:center;">
        <div style="margin-bottom:6px;">Mat</div>
        <button id="openMaterialsPicker" class="icon-btn" title="Open material swatches" aria-label="Open material swatches" type="button">
          <span class="sr-only">Open Material Swatches</span>
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <!-- Palette icon -->
            <path d="M12 3a9 9 0 1 0 0 18c2.2 0 3-1.2 3-2.2 0-1.2-.8-1.8-1.8-1.8h-1.2c-1 0-1.8-.8-1.8-1.8 0-1 .8-1.8 1.8-1.8h2c2.2 0 4-1.8 4-4 0-2.7-2.8-4.6-6-4.6Z" fill="none" stroke="#222" stroke-width="1.6"/>
            <circle cx="8" cy="10" r="1.2" fill="#222"/>
            <circle cx="10.5" cy="7.5" r="1.2" fill="#222"/>
            <circle cx="14" cy="7.8" r="1.2" fill="#222"/>
            <circle cx="16" cy="10.5" r="1.2" fill="#222"/>
          </svg>
        </button>
      </div>
      <div class="settings-compact">
        <div class="field">
          <label for="gridSizeInput">Size (ft)</label>
          <input id="gridSizeInput" type="number" min="1" step="1" value="20">
        </div>
        <div class="field">
          <label for="gridDivsInput">Divisions</label>
          <input id="gridDivsInput" type="number" min="1" step="1" value="20">
        </div>
        <button id="gridInfiniteBtn" class="icon-btn" title="Infinite grid + edge fade" aria-label="Infinite grid + edge fade" aria-pressed="false" type="button">
          <span class="sr-only">Infinite grid</span>
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M7 9c2 0 3 3 5 3s3-3 5-3 3 1.79 3 3-1 3-3 3-3-3-5-3-3 3-5 3-3-1.79-3-3 1-3 3-3z" fill="none" stroke="#222" stroke-width="2"/>
          </svg>
        </button>
      </div>
    </div>
    <!-- Textures parent button (opens Texture Editor) -->
    <button id="openTextureEditor" class="icon-btn" title="Textures" aria-label="Textures" type="button">
      <span class="sr-only">Textures</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <defs>
          <pattern id="chk" x="0" y="0" width="4" height="4" patternUnits="userSpaceOnUse">
            <rect x="0" y="0" width="2" height="2" fill="#222"/>
            <rect x="2" y="2" width="2" height="2" fill="#222"/>
          </pattern>
        </defs>
        <rect x="4" y="4" width="16" height="16" rx="2" fill="url(#chk)" stroke="#222" stroke-width="1.5"/>
      </svg>
    </button>
    <!-- Views parent button and group -->
    <button id="toggleViews" class="icon-btn toggle-btn" title="Views" aria-label="Views" aria-pressed="false">
      <span class="sr-only">Views</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
  <!-- Camera silhouette icon (enlarged to better match other icons) -->
  <rect x="3" y="7" width="18" height="10" rx="2" fill="none" stroke="#222" stroke-width="2"/>
  <rect x="6.5" y="4.8" width="11" height="3.4" rx="1.7" ry="1.7" fill="none" stroke="#222" stroke-width="2"/>
  <circle cx="12" cy="12" r="3.6" fill="none" stroke="#222" stroke-width="2"/>
      </svg>
    </button>
    <div id="viewsGroup" class="collapse" aria-hidden="true">
      <button id="viewAxon" class="icon-btn" title="Axonometric View (Ortho)" aria-label="Axonometric View (Ortho)">
        <span class="sr-only">Axonometric View (Ortho)</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <text x="12" y="16" text-anchor="middle" font-size="16" fill="#222" font-family="Arial" font-weight="bold">A</text>
        </svg>
      </button>
      <button id="viewPlan" class="icon-btn" title="Plan View" aria-label="Plan View">
        <span class="sr-only">Plan View</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <text x="12" y="16" text-anchor="middle" font-size="16" fill="#222" font-family="Arial" font-weight="bold">P</text>
        </svg>
      </button>
      <button id="viewNorth" class="icon-btn" title="North Elevation" aria-label="North Elevation">
        <span class="sr-only">North Elevation</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <text x="12" y="16" text-anchor="middle" font-size="16" fill="#222" font-family="Arial" font-weight="bold">N</text>
        </svg>
      </button>
      <button id="viewEast" class="icon-btn" title="East Elevation" aria-label="East Elevation">
        <span class="sr-only">East Elevation</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <text x="12" y="16" text-anchor="middle" font-size="16" fill="#222" font-family="Arial" font-weight="bold">E</text>
        </svg>
      </button>
      <button id="viewSouth" class="icon-btn" title="South Elevation" aria-label="South Elevation">
        <span class="sr-only">South Elevation</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <text x="12" y="16" text-anchor="middle" font-size="16" fill="#222" font-family="Arial" font-weight="bold">S</text>
        </svg>
      </button>
      <button id="viewWest" class="icon-btn" title="West Elevation" aria-label="West Elevation">
        <span class="sr-only">West Elevation</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <text x="12" y="16" text-anchor="middle" font-size="16" fill="#222" font-family="Arial" font-weight="bold">W</text>
        </svg>
      </button>
    </div>
    <!-- Plan View Lock (parent button at bottom) -->
    <button id="planLock" class="icon-btn" title="Plan View Lock" aria-label="Plan View Lock" aria-pressed="false">
      <span class="sr-only">Plan View Lock</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <text x="12" y="16" text-anchor="middle" font-size="13" fill="#222" font-family="Arial" font-weight="bold">PL</text>
      </svg>
    </button>
  </div>
  <!-- Mobile-only delete bar (appears below toolbox when selection exists) -->
  <div id="mobileDeleteBar" role="group" aria-label="Mobile actions">
    <button id="mobileDeleteBtn" class="icon-btn" title="Delete selected" aria-label="Delete selected" type="button">
      <span class="sr-only">Delete selected</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <!-- Trash can icon, matching line style -->
        <g fill="none" stroke="#222" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 7h16"/>
          <path d="M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
          <rect x="6" y="7" width="12" height="13" rx="2"/>
          <path d="M10 11v6M14 11v6"/>
        </g>
      </svg>
    </button>
  </div>
  <!-- Floating Visibility button (top-right cluster) -->
  <button id="toVisibility" class="floating-nav nav-bottom-toolbox-center" title="Visibility" aria-label="Visibility" type="button">
    <!-- Eye icon -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6S2 12 2 12z"/>
        <circle cx="12" cy="12" r="3"/>
      </g>
    </svg>
  </button>
  <!-- Visibility popup -->
  <div id="visibilityPopup" style="display:none;">
    <div class="visibility-header"><strong data-i18n="visibility.title">Visibility</strong></div>
    <div id="objectList"></div>
  </div>
  <!-- Materials popup (right side) -->
  <div id="materialsPopup" style="display:none;">
    <div class="materials-header"><strong>Mat</strong></div>
    <div class="materials-grid">
      <button id="matOriginal" class="mat-swatch" title="Original materials" aria-label="Original materials" aria-pressed="false" type="button">
        <div class="swatch-box" style="background:#ddd; border:1px solid #222;"></div>
        <div class="swatch-label">Original</div>
      </button>
      <button id="matCardboard" class="mat-swatch" title="Cardboard" aria-label="Cardboard" aria-pressed="false" type="button">
        <div class="swatch-box" style="background:#C9A46A; border:1px solid #222;"></div>
        <div class="swatch-label">Cardboard</div>
      </button>
      <button id="matMdf" class="mat-swatch" title="MDF" aria-label="MDF" aria-pressed="false" type="button">
        <div class="swatch-box" style="background:#B8AA8F; border:1px solid #222;"></div>
        <div class="swatch-label">MDF</div>
      </button>
        <button id="matSketch" class="mat-swatch" title="Sketch (hand-drawn)" aria-label="Sketch (hand-drawn)" aria-pressed="false" type="button">
          <div class="swatch-box" style="background:#ffffff; border:2px dashed #222;"></div>
          <div class="swatch-label">Sketch</div>
        </button>
    </div>
  </div>
  <!-- Texture/Material Editor popup (draggable, resizable) -->
  <div id="textureEditor" style="display:none; position:fixed; left: 96px; top: 96px; width: 320px; max-width: 90vw; background: rgba(255,255,255,0.86); border:1px solid #e0e0e0; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.12); z-index: 130; overflow: hidden;">
    <div class="te-header" style="cursor:move; padding:8px 12px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:8px; justify-content:space-between; user-select:none;">
      <div style="display:flex; align-items:center; gap:8px;">
        <strong style="font-family:sans-serif; font-size:13px; color:#222;">Textures</strong>
        <button id="teChooseFolder" class="btn" type="button" title="Set texture folder" aria-label="Set texture folder" style="width:28px; height:24px; padding:0; display:inline-flex; align-items:center; justify-content:center;">
          <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path d="M3 6h7l2 2h9v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6z" fill="none" stroke="#222" stroke-width="1.8"/></svg>
        </button>
        <span id="teFolderName" style="font-size:11px; color:#666; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">No folder</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <button id="teCompact" title="Compact layout" aria-label="Compact layout" class="btn" type="button" style="width:auto; height:24px; padding:0 8px; line-height:22px;">▦</button>
        <button id="textureEditorClose" title="Close" aria-label="Close" style="width:24px; height:24px; border:none; border-radius:50%; background:#f2f2f2; cursor:pointer;">×</button>
      </div>
    </div>
    <div class="te-body" style="padding:10px 12px; font-family:sans-serif; font-size:13px; color:#222;">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <label title="Apply to whole object" style="display:inline-flex; align-items:center; gap:6px;"><input type="radio" name="teTarget" value="object" checked><span class="sr-only">Object</span><svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><rect x="6" y="6" width="12" height="12" fill="none" stroke="#222" stroke-width="1.8"/></svg></label>
        <label title="Apply to a single face" style="display:inline-flex; align-items:center; gap:6px;"><input type="radio" name="teTarget" value="face"><span class="sr-only">Face</span><svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><polygon points="5,7 19,7 17,17 7,17" fill="none" stroke="#222" stroke-width="1.8"/></svg></label>
        <button id="tePickFace" class="btn" type="button" title="Pick face" style="margin-left:auto; width:28px; height:24px; padding:0; display:inline-flex; align-items:center; justify-content:center;">
          <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path d="M4 12h8l2 2h6" fill="none" stroke="#222" stroke-width="1.8"/></svg>
        </button>
      </div>
      <div class="te-grid-2">
        <label title="Base (image or video)"><span class="sr-only">Base</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="6" width="16" height="12" rx="2" fill="none" stroke="#222" stroke-width="1.8"/><circle cx="9" cy="12" r="2" fill="#222"/></svg><input id="teBaseName" type="text" placeholder="name.ext" list="teTexList"><input id="teBaseColor" type="file" accept="image/*,video/*"></label>
        <label title="Normal map"><span class="sr-only">Normal</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 16c4-6 12-6 16 0" fill="none" stroke="#222" stroke-width="1.8"/></svg><input id="teNormalName" type="text" placeholder="name.ext" list="teTexList"><input id="teNormal" type="file" accept="image/*"></label>
        <label title="Roughness map"><span class="sr-only">Roughness</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 8l4 8 4-8 4 8" fill="none" stroke="#222" stroke-width="1.8"/></svg><input id="teRoughnessName" type="text" placeholder="name.ext" list="teTexList"><input id="teRoughness" type="file" accept="image/*"></label>
        <label title="Metalness map"><span class="sr-only">Metalness</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><circle cx="8" cy="12" r="3" fill="none" stroke="#222" stroke-width="1.8"/><circle cx="16" cy="12" r="3" fill="none" stroke="#222" stroke-width="1.8"/></svg><input id="teMetalnessName" type="text" placeholder="name.ext" list="teTexList"><input id="teMetalness" type="file" accept="image/*"></label>
        <label title="Ambient Occlusion map"><span class="sr-only">AO</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="5" fill="none" stroke="#222" stroke-width="1.8"/><circle cx="12" cy="12" r="2" fill="#222"/></svg><input id="teAOName" type="text" placeholder="name.ext" list="teTexList"><input id="teAO" type="file" accept="image/*"></label>
        <label title="Emissive (image or video)"><span class="sr-only">Emissive</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5v4M12 15v4M5 12h4M15 12h4" stroke="#222" stroke-width="1.8"/><circle cx="12" cy="12" r="3" fill="none" stroke="#222" stroke-width="1.8"/></svg><input id="teEmissiveName" type="text" placeholder="name.ext" list="teTexList"><input id="teEmissive" type="file" accept="image/*,video/*"></label>
        <label title="Alpha map"><span class="sr-only">Alpha</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><rect x="5" y="7" width="14" height="10" fill="none" stroke="#222" stroke-width="1.8"/><path d="M5 17h14" stroke="#222" stroke-width="1.8"/></svg><input id="teAlphaName" type="text" placeholder="name.ext" list="teTexList"><input id="teAlpha" type="file" accept="image/*"></label>
      </div>
      <datalist id="teTexList"></datalist>
      <hr style="margin:10px 0; border:none; border-top:1px solid #eee;">
      <div class="te-grid-2">
        <label title="Repeat U"><span class="sr-only">Repeat X</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 7h10M7 12h10M7 17h10" stroke="#222" stroke-width="1.8"/></svg><input id="teRepeatX" type="number" step="0.1" value="1"></label>
        <label title="Repeat V"><span class="sr-only">Repeat Y</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 7v10M12 7v10M17 7v10" stroke="#222" stroke-width="1.8"/></svg><input id="teRepeatY" type="number" step="0.1" value="1"></label>
        <label title="Offset U"><span class="sr-only">Offset X</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14M12 5v14" stroke="#222" stroke-width="1.8"/></svg><input id="teOffsetX" type="number" step="0.01" value="0"></label>
        <label title="Offset V"><span class="sr-only">Offset Y</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14" stroke="#222" stroke-width="1.8"/></svg><input id="teOffsetY" type="number" step="0.01" value="0"></label>
        <label title="Rotation (radians)"><span class="sr-only">Rotation</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5a7 7 0 1 1-7 7" fill="none" stroke="#222" stroke-width="1.8"/><path d="M5 8v-3h3" fill="none" stroke="#222" stroke-width="1.8"/></svg><input id="teRotation" type="number" step="0.01" value="0"></label>
        <label title="Normal strength"><span class="sr-only">Normal Strength</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 16c4-6 12-6 16 0" fill="none" stroke="#222" stroke-width="1.8"/></svg><input id="teNormalScale" type="number" step="0.1" value="1"></label>
        <label title="Roughness scalar"><span class="sr-only">Roughness</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 8l4 8 4-8 4 8" fill="none" stroke="#222" stroke-width="1.8"/></svg><input id="teRoughnessScalar" type="number" step="0.05" min="0" max="1" value="1"></label>
        <label title="Metalness scalar"><span class="sr-only">Metalness</span><svg class="te-ico" viewBox="0 0 24 24" aria-hidden="true"><circle cx="8" cy="12" r="3" fill="none" stroke="#222" stroke-width="1.8"/><circle cx="16" cy="12" r="3" fill="none" stroke="#222" stroke-width="1.8"/></svg><input id="teMetalnessScalar" type="number" step="0.05" min="0" max="1" value="0"></label>
      </div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="teApply" class="btn primary" type="button">Apply</button>
        <button id="teClear" class="btn" type="button" title="Clear" aria-label="Clear">
          <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
            <rect x="5" y="5" width="14" height="14" rx="2" fill="none" stroke="#222" stroke-width="2"/>
            <path d="M8 8l8 8M16 8l-8 8" stroke="#222" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="te-resizer" style="position:absolute; right:4px; bottom:4px; width:14px; height:14px; cursor:nwse-resize; opacity:0.6;">
      <svg viewBox="0 0 10 10" width="14" height="14"><path d="M0 10 L10 0 M3 10 L10 3 M6 10 L10 6" stroke="#999"/></svg>
    </div>
  </div>
  <!-- Parent Columbarium button (opens Personal/Community popup) -->
  <button id="openColMenu" class="floating-nav nav-top-right" title="Columbarium" aria-label="Columbarium" type="button">
    <!-- Tic-tac-toe grid, no filled square -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <g fill="none" stroke="#fff" stroke-width="1.8" opacity=".9">
        <path d="M8 3v18M16 3v18M3 8h18M3 16h18"/>
      </g>
    </svg>
  </button>
  <!-- Columbarium popup menu -->
  <div id="columbariumPopup" style="display:none; position:fixed; right:20px; top:76px; z-index: 210;">
    <!-- Two floating-style items that animate out from the parent button position -->
    <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
      <a id="colPersonal" class="floating-nav" href="./columbarium.html" title="Personal" aria-label="Personal">
  <!-- Personal icon: tic-tac-toe with filled center (dark), no arrow -->
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <g fill="none" stroke="#fff" stroke-width="1.8" opacity=".95">
            <path d="M8 3v18M16 3v18M3 8h18M3 16h18"/>
          </g>
          <rect x="8.9" y="8.9" width="6.2" height="6.2" fill="#fff" opacity=".95"/>
        </svg>
      </a>
      <a id="colCommunity" class="floating-nav" href="./community.html" title="Community" aria-label="Community">
  <!-- Community icon: tic-tac-toe with magenta center, no arrow -->
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <g fill="none" stroke="#fff" stroke-width="1.8" opacity=".95">
            <path d="M8 3v18M16 3v18M3 8h18M3 16h18"/>
          </g>
          <rect x="8.9" y="8.9" width="6.2" height="6.2" fill="#ff00ff" opacity=".98"/>
        </svg>
      </a>
    </div>
  </div>
    <!-- Floating AR button (top-right, beside Columbarium) -->
  <!-- Move 2D Sketch up before AR -->
  <!-- Floating 2D Sketch button (now next to Columbarium) -->
  <a id="toSketch2D" class="floating-nav nav-top-right-2" href="./sketch2d.html" title="2D Sketch" aria-label="2D Sketch">
    <!-- 2D/3D toggle icon: flat grid -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <g fill="none" stroke="#fff" stroke-width="1.8" opacity=".92">
        <rect x="4" y="4" width="16" height="16" rx="2"/>
        <path d="M4 12h16M12 4v16" opacity=".9"/>
      </g>
    </svg>
  </a>
  <!-- AR remains after 2D -->
  <button id="toAR" class="floating-nav nav-top-right-3" title="Enter AR" aria-label="Enter AR" type="button">
      <!-- Glasses icon: two lenses with a bridge and subtle temples -->
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <g fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8">
          <!-- Lenses pushed outward -->
          <circle cx="7" cy="12" r="3.6"/>
          <circle cx="17" cy="12" r="3.6"/>
          <!-- Narrow bridge to reduce chain-like look -->
          <path d="M10.8 11.6c.5-.35 1.9-.35 2.4 0"/>
          <!-- Temples -->
          <path d="M3.4 12h-1.2"/>
          <path d="M20.6 12h1.2"/>
        </g>
      </svg>
    </button>
  <!-- Floating Legend button (move to far-left position) -->
  <button id="toLegend" class="floating-nav nav-top-right-5" title="Legend / Help" aria-label="Legend / Help" type="button">
      <!-- Info-circle icon -->
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round">
          <circle cx="12" cy="12" r="9"/>
          <path d="M12 17v-6"/>
          <circle cx="12" cy="8" r="1" fill="#fff" stroke="none"/>
        </g>
      </svg>
    </button>
  <!-- Legend/Help popup (expanded, scrollable) -->
  <div id="legendPopup" style="display:none; max-width: 520px; max-height: 70vh; overflow: auto; backdrop-filter: blur(6px);">
      <div class="legend-welcome">
    <h3>Sketcher</h3>
    <div class="legend-tagline">Lightweight 3D sketching + collecting</div>
        <div class="legend-quick">
          <!-- Navigation -->
          <div class="quick-item" title="Rotate / Pan / Zoom">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5.5"/>
                <path d="M12 3.5v2.2M20.5 12h-2.2M12 20.5v-2.2M3.5 12h2.2" opacity=".9"/>
                <path d="M16 8l2-2M8 8L6 6M16 16l2 2M8 16l-2 2" opacity=".7"/>
              </g>
            </svg>
            <div class="quick-label">Navigate</div>
          </div>
          <!-- Select/Edit -->
          <div class="quick-item" title="Select and edit with gizmo or handles">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <rect x="6" y="6" width="12" height="12" rx="1.5"/>
                <path d="M12 6v12M6 12h12" opacity=".85"/>
                <path d="M5.2 5.2l2 2M18.8 5.2l-2 2M5.2 18.8l2-2M18.8 18.8l-2-2" opacity=".7"/>
              </g>
            </svg>
            <div class="quick-label">Edit</div>
          </div>
          <!-- Handles -->
          <div class="quick-item" title="Double‑click to show handles; drag corners/edges/faces">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <rect x="7" y="7" width="10" height="10"/>
                <circle cx="7" cy="7" r="1.2" fill="#fff" stroke="none"/>
                <circle cx="17" cy="7" r="1.2" fill="#fff" stroke="none"/>
                <circle cx="7" cy="17" r="1.2" fill="#fff" stroke="none"/>
                <circle cx="17" cy="17" r="1.2" fill="#fff" stroke="none"/>
              </g>
            </svg>
            <div class="quick-label">Handles</div>
          </div>
          <!-- Snap -->
          <div class="quick-item" title="Soft snap on contact; keep dragging to push past">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M7 5h4a4 4 0 0 1 4 4v1M17 19h-4a4 4 0 0 1-4-4v-1"/>
                <path d="M17 5v4M7 19v-4"/>
              </g>
            </svg>
            <div class="quick-label">Snap</div>
          </div>
          <!-- Scenes -->
          <div class="quick-item" title="Autosaves between reloads; use Scenes to Save/Load; New Scene clears">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <rect x="4" y="4" width="16" height="16" rx="2"/>
                <path d="M7 8h6"/>
                <rect x="7" y="12" width="10" height="6" rx="1"/>
              </g>
            </svg>
            <div class="quick-label">Scenes</div>
          </div>
        </div>
      </div>
  <div class="legend-grid">
        <!-- Primitives -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <polygon points="3,11 12,4 21,11" fill="none" stroke="#fff" stroke-width="2"/>
            <rect x="6" y="11" width="12" height="9" fill="none" stroke="#fff" stroke-width="2"/>
            <rect x="11" y="14" width="2" height="6" fill="none" stroke="#fff" stroke-width="2"/>
          </svg>
        </div>
        <div class="legend-label">Primitives</div>

        <!-- Draw (pencil) -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 19l3.2-.8 9.7-9.7a1.6 1.6 0 0 0 0-2.3l-.1-.1a1.6 1.6 0 0 0-2.3 0L5.8 15.8 5 19z"/>
              <path d="M14.8 6.2l3 3" opacity=".9"/>
              <path d="M4 20c3 -.2 5.2 -.8 7.6 -2.2" opacity=".8"/>
            </g>
          </svg>
        </div>
        <div class="legend-label">Draw</div>

        <!-- 2D Sketch (flat grid) -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="none" stroke="#fff" stroke-width="1.8" opacity=".95">
              <rect x="4" y="4" width="16" height="16" rx="2"/>
              <path d="M4 12h16M12 4v16" opacity=".9"/>
            </g>
          </svg>
        </div>
        <div class="legend-label">2D Sketch</div>

        <!-- Utilities -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <rect x="3" y="9" width="18" height="10" rx="2" ry="2" fill="none" stroke="#fff" stroke-width="2"/>
            <rect x="8" y="6" width="8" height="3" rx="1.5" ry="1.5" fill="none" stroke="#fff" stroke-width="2"/>
            <path d="M8 9V7m8 2V7" stroke="#fff" stroke-width="2"/>
          </svg>
        </div>
  <div class="legend-label">Utilities</div>

        <!-- Center Sketch (return to center) -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 3v6"/>
              <polyline points="9,7 12,10 15,7"/>
              <path d="M12 21v-6"/>
              <polyline points="9,17 12,14 15,17"/>
              <path d="M3 12h6"/>
              <polyline points="7,9 10,12 7,15"/>
              <path d="M21 12h-6"/>
              <polyline points="17,9 14,12 17,15"/>
            </g>
          </svg>
        </div>
        <div class="legend-label">Center Sketch</div>

        <!-- Scene Manager (tic-tac-toe) -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="#fff" stroke-width="1.8"><path d="M8 3v18M16 3v18M3 8h18M3 16h18"/></g><rect x="8.9" y="8.9" width="6.2" height="6.2" fill="#fff"/></svg>
        </div>
  <div class="legend-label">Scenes</div>

        <!-- Columbarium (parent) -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="none" stroke="#fff" stroke-width="1.8" opacity=".95">
              <path d="M8 3v18M16 3v18M3 8h18M3 16h18"/>
            </g>
          </svg>
        </div>
        <div class="legend-label">Columbarium</div>

        <!-- Columbarium → Personal -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="none" stroke="#fff" stroke-width="1.8" opacity=".95">
              <path d="M8 3v18M16 3v18M3 8h18M3 16h18"/>
            </g>
            <rect x="8.9" y="8.9" width="6.2" height="6.2" fill="#fff" opacity=".95"/>
          </svg>
        </div>
        <div class="legend-label">Personal</div>

        <!-- Columbarium → Community -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="none" stroke="#fff" stroke-width="1.8" opacity=".95">
              <path d="M8 3v18M16 3v18M3 8h18M3 16h18"/>
            </g>
            <rect x="8.9" y="8.9" width="6.2" height="6.2" fill="#ff00ff" opacity=".98"/>
          </svg>
        </div>
        <div class="legend-label">Community</div>

        <!-- Import -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="2" fill="none" stroke="#fff" stroke-width="2"/><path d="M12 8v6" stroke="#fff" stroke-width="2"/><path d="M9 14l3 3 3-3" fill="none" stroke="#fff" stroke-width="2"/></svg>
          </div>
  <div class="legend-label">Import</div>

        <!-- Settings (gear) -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M19.4 12.94a7.5 7.5 0 0 0 0-1.88l2.02-1.57a.6.6 0 0 0 .14-.78l-1.91-3.3a.6.6 0 0 0-.73-.27l-2.38.96a7.6 7.6 0 0 0-1.62-.94l-.36-2.54A.6.6 0 0 0 14 .8h-3.82a.6.6 0 0 0-.59.49l-.36 2.54c-.57.23-1.12.53-1.62.94l-2.38-.96a.6.6 0 0 0-.73.27l-1.91 3.3a.6.6 0 0 0 .14.78L4.6 11.06a7.5 7.5 0 0 0 0 1.88l-2.02 1.57a.6.6 0 0 0-.14.78l1.91 3.3c.13.22.4.32.64.23l2.38-.96c.5.41 1.05.72 1.62.94l.36 2.54c.05.29.3.49.59.49H14c.29 0 .54-.2.59-.49l.36-2.54c.57-.23 1.12-.53 1.62-.94l2.38.96c.24.09.51-.01.64-.23l1.91-3.3a.6.6 0 0 0-.14-.78l-2.02-1.57z"/><circle cx="12" cy="12" r="3.5"/></g></svg>
        </div>
  <div class="legend-label">Settings</div>

        <!-- Views (camera) -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <rect x="5" y="8" width="14" height="9" rx="2" fill="none" stroke="#fff" stroke-width="2"/>
            <rect x="8" y="6" width="8" height="3" rx="1.5" ry="1.5" fill="none" stroke="#fff" stroke-width="2"/>
            <circle cx="12" cy="12.5" r="3" fill="none" stroke="#fff" stroke-width="2"/>
          </svg>
        </div>
  <div class="legend-label">Views</div>

        <!-- AR (glasses) -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8">
              <circle cx="7" cy="12" r="3.6"/>
              <circle cx="17" cy="12" r="3.6"/>
              <path d="M10.8 11.6c.5-.35 1.9-.35 2.4 0"/>
              <path d="M3.4 12h-1.2"/>
              <path d="M20.6 12h1.2"/>
            </g>
          </svg>
        </div>
  <div class="legend-label">AR</div>

        <!-- Room Scan (point cloud) -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="#fff" stroke="none">
              <circle cx="7" cy="9" r="1.2"/>
              <circle cx="10" cy="7" r="1.1"/>
              <circle cx="13" cy="9" r="1.2"/>
              <circle cx="16" cy="8" r="1.0"/>
              <circle cx="8.5" cy="12" r="1.3"/>
              <circle cx="11.5" cy="12.5" r="1.1"/>
              <circle cx="14.5" cy="12" r="1.3"/>
              <circle cx="18" cy="11" r="1.0"/>
              <circle cx="6.5" cy="14.5" r="1.0" opacity=".85"/>
              <circle cx="9.5" cy="15" r="1.2" opacity=".9"/>
              <circle cx="12.5" cy="15.5" r="1.0" opacity=".9"/>
              <circle cx="15.5" cy="15" r="1.2" opacity=".85"/>
              <circle cx="18.5" cy="14" r="1.0" opacity=".8"/>
            </g>
          </svg>
        </div>
        <div class="legend-label">Room Scan</div>
        
        <!-- Plan Lock & Walls/Floors quick tips -->
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <rect x="4" y="4" width="16" height="16" rx="2"/>
              <path d="M4 12h16" opacity=".85"/>
            </g>
          </svg>
        </div>
        <div class="legend-label">Plan Lock locks camera to top view; drag shows 2D outlines for floors and walls.</div>
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="none" stroke="#fff" stroke-width="1.8">
              <rect x="3" y="10" width="18" height="4"/>
            </g>
          </svg>
        </div>
        <div class="legend-label">Walls are placed by dragging start→end; the gizmo centers on the wall midpoint for easy edits.</div>
        <div class="legend-item">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="none" stroke="#fff" stroke-width="1.8">
              <rect x="5" y="14" width="14" height="6"/>
            </g>
          </svg>
        </div>
        <div class="legend-label">Floors drag corner→corner; height is constant and can be edited later.</div>
      </div>

      <div class="legend-section">
        <h4>What you can do</h4>
        <ul>
          <li>Create simple shapes, floors, and walls quickly.</li>
          <li>Select, move, rotate, and resize with gizmos or handles.</li>
          <li>Apply materials, import models and maps, save/load scenes.</li>
          <li>Toggle views (axon/plan/elevations), lock plan for 2D drafting.</li>
          <li>Enter AR to view your model at scale; scan rooms (beta).</li>
          <li>Share to Community and trade for inspiration.</li>
        </ul>
      </div>

      <div class="legend-section">
        <h4>Quick start</h4>
        <ol>
          <li>Open Draw → use Click‑Drag Create to sketch a box or cylinder.</li>
          <li>Add a Floor or Wall from Utilities. Drag start → end.</li>
          <li>Click an object to select; use arrows (move) or ring (rotate).</li>
          <li>Double‑click a selection to reveal corner/edge/face handles for quick size edits.</li>
          <li>Open Materials to try a few looks. Save your scene in Scenes.</li>
        </ol>
      </div>

      <div class="legend-section two-col">
        <div>
          <h4>Navigate</h4>
          <ul>
            <li>Mouse: Left‑drag = rotate, Middle/Right‑drag = pan, Wheel = zoom.</li>
            <li>Touch: One‑finger drag = rotate, Two‑finger drag = pan, Pinch = zoom.</li>
            <li>Plan Lock: locks top view and prevents rotation.</li>
          </ul>
        </div>
        <div>
          <h4>Create</h4>
          <ul>
            <li>Click‑Drag Create: drag on the ground to size; release to place.</li>
            <li>Floor: drag corner → corner. Fixed thickness; edit later if needed.</li>
            <li>Wall: drag start → end; 10' tall by default; gizmo at midpoint.</li>
            <li>Plan Lock: shows thin drag outlines for precise floors/walls.</li>
          </ul>
        </div>
      </div>

      <div class="legend-section two-col">
        <div>
          <h4>Select & Edit</h4>
          <ul>
            <li>Click to select. Ctrl/Shift/⌘‑click to multi‑select.</li>
            <li>Gizmo: translate (arrows) or rotate (ring). For multi‑select, a shared pivot appears.</li>
            <li>Handles: double‑click to show, then drag corners/edges/faces to resize.</li>
            <li>Return to Floor: snaps one or many selections to the ground.</li>
            <li>Soft Snap: objects nudge and align on contact; keep dragging to push past.</li>
          </ul>
        </div>
        <div>
          <h4>Materials</h4>
          <ul>
            <li>Open swatches, then click to apply to the current selection.</li>
            <li>Shared procedural looks keep scenes consistent and fast.</li>
          </ul>
        </div>
      </div>

      <div class="legend-section two-col">
        <div>
          <h4>Scenes</h4>
          <ul>
            <li>Autosaves your last state between reloads.</li>
            <li>Use Save/Load for named local scenes. New Scene clears the canvas.</li>
          </ul>
          <h4>Import</h4>
          <ul>
            <li>Import models (OBJ/GLTF). Use the map tool to import Flat/Topo tiles.</li>
          </ul>
        </div>
        <div>
          <h4>Views & Plan Lock</h4>
          <ul>
            <li>Switch among Axon, Plan, North/South/East/West.</li>
            <li>With Plan Lock, rotation is disabled and drag outlines appear.</li>
          </ul>
          <h4>AR & Scan</h4>
          <ul>
            <li>Enter AR to place your model at real scale (device support required).</li>
            <li>Room Scan (beta) previews a floor and low walls from a quick scan.</li>
          </ul>
        </div>
      </div>

      <div class="legend-section two-col">
        <div>
          <h4>Visibility</h4>
          <ul>
            <li>Use the bottom‑left panel to show/hide objects and manage clutter.</li>
          </ul>
          <h4>Community</h4>
          <ul>
            <li>Share to Community to publish a snapshot and trade; you’ll pick from a few community scenes right after sharing.</li>
          </ul>
        </div>
        <div>
          <h4>Shortcuts</h4>
          <ul>
            <li>Delete/Backspace: delete selection.</li>
            <li>Esc: cancel active tool or placing.</li>
            <li>Ctrl/Shift/⌘‑click: add/remove from selection.</li>
          </ul>
        </div>
      </div>
    </div>
      <!-- Floating Room Scan button (top-right, beside Legend) -->
  <button id="toRoomScan" class="floating-nav nav-top-right-4" title="Scan Room (beta)" aria-label="Scan Room" type="button">
        <!-- Point cloud icon: scattered dots forming a loose cloud -->
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <g fill="#fff" stroke="none">
            <circle cx="7" cy="9" r="1.2"/>
            <circle cx="10" cy="7" r="1.1"/>
            <circle cx="13" cy="9" r="1.2"/>
            <circle cx="16" cy="8" r="1.0"/>
            <circle cx="8.5" cy="12" r="1.3"/>
            <circle cx="11.5" cy="12.5" r="1.1"/>
            <circle cx="14.5" cy="12" r="1.3"/>
            <circle cx="18" cy="11" r="1.0"/>
            <circle cx="6.5" cy="14.5" r="1.0" opacity=".85"/>
            <circle cx="9.5" cy="15" r="1.2" opacity=".9"/>
            <circle cx="12.5" cy="15.5" r="1.0" opacity=".9"/>
            <circle cx="15.5" cy="15" r="1.2" opacity=".85"/>
            <circle cx="18.5" cy="14" r="1.0" opacity=".8"/>
          </g>
        </svg>
      </button>
  <div id="version-badge" role="button" tabindex="0" title="About / AnArch" aria-label="About / AnArch" style="position:fixed; right:12px; bottom:12px; background:rgba(0,0,0,0.8); color:#fff; padding:6px 8px; border-radius:6px; font-family:sans-serif; font-size:12px; z-index:220; line-height:1; white-space:nowrap; box-shadow:0 2px 10px rgba(0,0,0,0.25); min-width: 96px; text-align:center; cursor:pointer; user-select:none;">
    v1.1.0
  </div>
  <!-- Floating 2D Sketch button (top-right, next to AR) -->
  
      <!-- Room Scan HUD -->
      <div id="scanHud" style="display:none;">
        <div class="scan-hud-title">Room Scan</div>
        <div id="scanHudStatus" class="scan-hud-status">Preparing…</div>
        <button id="scanHudCancel" class="scan-hud-cancel" title="Cancel scan" aria-label="Cancel scan" type="button">×</button>
      </div>
  <div id="error-banner" style="position:fixed;left:0;right:0;bottom:0;background:#ffe3e3;color:#900;padding:6px 10px;font-family:sans-serif;font-size:12px;display:none;z-index:9999;"></div>
  <!-- Map modal overlay -->
  <div id="mapModalBackdrop">
    <div id="mapModal">
      <div id="mapModalHeader">
        <input type="text" id="mapSearch" placeholder="Search location (OSM/Nominatim)">
        <button id="mapSearchBtn" class="btn">Search</button>
        <button id="mapDrawToggle" class="btn" aria-pressed="false" title="Draw a selection box on the map">Draw Box</button>
        <button id="mapCloseBtn" class="btn">Close</button>
      </div>
      <div id="mapContainer"></div>
      <div id="mapModalFooter">
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="mapUseFlat" class="btn primary" title="Import a flat plane textured with satellite imagery">Import Flat</button>
          <button id="mapUseTopo" class="btn" title="Import topography with satellite imagery">Import Topo</button>
        </div>
        <div style="font-size:12px;color:#444;">Select a region with Draw Box, then choose an import type.</div>
      </div>
  </div>
  <script type="module">
  import { init } from './js/app/app.js';
    // Fade-in on load
    document.addEventListener('DOMContentLoaded', () => {
      requestAnimationFrame(()=>document.body.classList.add('page-ready'));
      const link = document.getElementById('toColumbarium');
    if (link) {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const href = link.getAttribute('href');
      document.body.classList.add('page-leave');
      setTimeout(()=>{ window.location.href = href; }, 170);
        });
      }
        // AnArch trigger: click version badge
        (async () => {
          try {
            const mod = await import('./js/app/anarch.js');
            const badge = document.getElementById('version-badge');
            if (mod && mod.triggerAnArchSequence && badge) {
              const run = () => { try { mod.triggerAnArchSequence(); } catch {} };
              badge.addEventListener('click', run);
              badge.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); run(); } });
            }
          } catch {}
        })();

        // Load UI wiring for Materials popup (safe additive module)
        (async () => {
          try { await import('./js/app/ui/materials-popup.js'); } catch {}
        })();
        // Load Texture Editor UI module
        (async () => {
          try { await import('./js/app/ui/texture-editor.js'); } catch {}
        })();
        // Load UI wiring for Views + Plan Lock (safe additive module)
        (async () => {
          try { await import('./js/app/ui/views.js'); } catch {}
        })();
  // Community nav fade
        const toCommunity = document.getElementById('toCommunity');
        if (toCommunity) {
          toCommunity.addEventListener('click', (e) => {
            e.preventDefault();
            const href = toCommunity.getAttribute('href');
            document.body.classList.add('page-leave');
            setTimeout(()=>{ window.location.href = href; }, 170);
          });
        }
  // AR floating button triggers existing AR flow
        const toAR = document.getElementById('toAR');
        if (toAR) {
          toAR.addEventListener('click', () => {
            const arBtn = document.getElementById('arButton');
            if (arBtn) arBtn.click();
          });
        }
  // Legend button toggles popup below it
        const toLegend = document.getElementById('toLegend');
        const legendPopup = document.getElementById('legendPopup');
        if (toLegend && legendPopup) {
          const placePopup = () => {
            // Position just under the legend button
            const btnRect = toLegend.getBoundingClientRect();
            const popup = legendPopup;
            popup.style.left = Math.max(12, btnRect.right - popup.offsetWidth) + 'px';
            popup.style.top = (btnRect.bottom + 10) + 'px';
          };
          const openPopup = () => {
            legendPopup.style.display = 'block';
            // Wait a frame for dimensions then place and animate open
            requestAnimationFrame(() => {
              placePopup();
              legendPopup.classList.add('open');
            });
          };
          const closePopup = () => {
            legendPopup.classList.remove('open');
            setTimeout(()=>{ legendPopup.style.display = 'none'; }, 180);
          };
          toLegend.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = legendPopup.classList.contains('open');
            if (isOpen) closePopup(); else openPopup();
          });
          document.addEventListener('click', (e) => {
            if (!legendPopup.contains(e.target) && e.target !== toLegend) {
              if (legendPopup.classList.contains('open')) closePopup();
            }
          });
          window.addEventListener('resize', () => { if (legendPopup.classList.contains('open')) placePopup(); });
        }

        // Visibility button toggles popup below it
        const toVisibility = document.getElementById('toVisibility');
        const visibilityPopup = document.getElementById('visibilityPopup');
        if (toVisibility && visibilityPopup) {
          const placeVisPopup = () => {
            const btnRect = toVisibility.getBoundingClientRect();
            const popup = visibilityPopup;
            const rightOfBtn = btnRect.right + 10;
            const centeredTop = btnRect.top + (btnRect.height / 2) - (popup.offsetHeight / 2);
            const clampedLeft = Math.max(12, Math.min(rightOfBtn, window.innerWidth - popup.offsetWidth - 12));
            const clampedTop = Math.max(12, Math.min(centeredTop, window.innerHeight - popup.offsetHeight - 12));
            popup.style.left = clampedLeft + 'px';
            popup.style.top = clampedTop + 'px';
          };
          const openVis = () => {
            visibilityPopup.style.display = 'block';
            requestAnimationFrame(() => {
              placeVisPopup();
              visibilityPopup.classList.add('open');
            });
          };
          const closeVis = () => {
            visibilityPopup.classList.remove('open');
            setTimeout(()=>{ visibilityPopup.style.display = 'none'; }, 180);
          };
          toVisibility.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = visibilityPopup.classList.contains('open');
            if (isOpen) closeVis(); else openVis();
          });
          document.addEventListener('click', (e) => {
            if (!visibilityPopup.contains(e.target) && e.target !== toVisibility) {
              if (visibilityPopup.classList.contains('open')) closeVis();
            }
          });
          window.addEventListener('resize', () => { if (visibilityPopup.classList.contains('open')) placeVisPopup(); });
        }
        // Room Scan button triggers scan flow
        const toRoomScan = document.getElementById('toRoomScan');
        if (toRoomScan) {
          toRoomScan.addEventListener('click', () => {
            // Delegate to app.js handler
            document.dispatchEvent(new CustomEvent('sketcher:startRoomScan'));
          });
        }
    // Materials popup open/close and placement (dock next to the toolbox button)
        const openMaterialsPicker = document.getElementById('openMaterialsPicker');
        const materialsPopup = document.getElementById('materialsPopup');
        if (openMaterialsPicker && materialsPopup) {
          const placeMatPopup = () => {
      const btnRect = openMaterialsPicker.getBoundingClientRect();
      const popup = materialsPopup;
      const width = popup.offsetWidth || 200;
      const height = popup.offsetHeight || 140;
      // Place to the right of the button, vertically centered on the button
      const proposedLeft = Math.round(btnRect.right + 10);
      const proposedTop = Math.round(btnRect.top + (btnRect.height / 2) - (height / 2));
      const left = Math.min(proposedLeft, window.innerWidth - width - 12);
      const top = Math.max(12, Math.min(proposedTop, window.innerHeight - height - 12));
      popup.style.left = left + 'px';
      popup.style.top = top + 'px';
          };
          const openMat = () => {
            materialsPopup.style.display = 'block';
            requestAnimationFrame(() => {
              placeMatPopup();
              materialsPopup.classList.add('open');
            });
          };
          const closeMat = () => {
            materialsPopup.classList.remove('open');
            setTimeout(()=>{ materialsPopup.style.display = 'none'; }, 180);
          };
          openMaterialsPicker.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = materialsPopup.classList.contains('open');
            if (isOpen) closeMat(); else openMat();
          });
          document.addEventListener('click', (e) => {
            if (!materialsPopup.contains(e.target) && e.target !== openMaterialsPicker) {
              if (materialsPopup.classList.contains('open')) closeMat();
            }
          });
          window.addEventListener('resize', () => { if (materialsPopup.classList.contains('open')) placeMatPopup(); });
        }
        // Texture editor open/close and placement
        const openTextureEditorBtn = document.getElementById('openTextureEditor');
        const textureEditor = document.getElementById('textureEditor');
        const textureEditorClose = document.getElementById('textureEditorClose');
        if (openTextureEditorBtn && textureEditor) {
          const placeTE = () => {
            const r = openTextureEditorBtn.getBoundingClientRect();
            const width = textureEditor.offsetWidth || 320;
            const height = textureEditor.offsetHeight || 240;
            const proposedLeft = Math.round(r.right + 10);
            const proposedTop = Math.round(r.top + (r.height/2) - (height/2));
            const left = Math.min(proposedLeft, window.innerWidth - width - 12);
            const top = Math.max(12, Math.min(proposedTop, window.innerHeight - height - 12));
            textureEditor.style.left = left + 'px';
            textureEditor.style.top = top + 'px';
          };
          openTextureEditorBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = textureEditor.style.display !== 'none';
            if (!isOpen) {
              textureEditor.style.display = 'block';
              requestAnimationFrame(()=>{ placeTE(); });
            } else {
              textureEditor.style.display = 'none';
            }
          });
          if (textureEditorClose) textureEditorClose.addEventListener('click', ()=>{ textureEditor.style.display = 'none'; });
          document.addEventListener('click', (e) => {
            if (textureEditor.style.display !== 'none' && !textureEditor.contains(e.target) && e.target !== openTextureEditorBtn) {
              textureEditor.style.display = 'none';
            }
          });
          window.addEventListener('resize', () => { if (textureEditor.style.display !== 'none') placeTE(); });
        }
    });
    init();
  </script>
  <script type="module">
  // Share to Community flow (Supabase backend): serialize current scene, save to community, then redirect to Community for trade picks
    import * as communityApi from './js/app/services/community-api.js';
    const btn = document.getElementById('shareToCommunity');
    if (btn) {
      btn.addEventListener('click', async () => {
        try {
          const serialize = window.sketcherSerializeScene;
          const countFn = window.sketcherObjectCount;
          if (typeof serialize !== 'function') { alert('Unable to read the current scene to share.'); return; }
          // Enforce minimum of five objects before sharing
          try {
            const n = (typeof countFn === 'function') ? countFn() : ((serialize()?.object?.children||[]).length);
            if (!isFinite(n) || n < 5) { alert('Please add at least five objects before sharing to the Community.'); return; }
          } catch {}
          const json = serialize();
          // Use the DOM-free thumbnail generator to avoid module side effects on non-columbarium pages
          const thumb = await (await import('./js/app/community.js')).generateSceneThumbnail(json).catch(()=>null);
          const name = prompt('Name your community scene:', 'My Scene') || 'Untitled';
          const saved = await communityApi.saveCommunityScene({ name, json, thumb });
          // Redirect to community with trade intent and the new id
          try { sessionStorage.setItem('sketcher:tradeToken', saved.id); } catch {}
          document.body.classList.add('page-leave');
          setTimeout(()=>{ window.location.href = `./community.html?just=${encodeURIComponent(saved.id)}&trade=1`; }, 170);
        } catch (e) {
          console.error(e);
          const msg = (e && (e.message || e.error_description || e.code)) ? `Failed to share to community (backend): ${e.message || e.error_description || e.code}` : 'Failed to share to community (backend).';
          alert(msg);
        }
      });
    }
  </script>
</body>
</html>